MWF.xDesktop.requireApp("process.Xform","Attachment",null,false);MWF.xDesktop.requireApp("cms.FormDesigner","widget.AttachmentController",null,false);MWF.xApplication.cms.Xform.AttachmentController=new Class({Extends:MWF.xApplication.cms.FormDesigner.widget.AttachmentController,options:{officeFiles:["doc","docx","dotx","dot","xls","xlsx","xlsm","xlt","xltx","pptx","ppt","pot","potx","potm","pdf"]},checkDeleteAction:function(){if(this.options.readonly){this.setActionDisabled(this.deleteAction);this.setActionDisabled(this.min_deleteAction);return false}if(this.options.isDeleteOption!=="y"&&this.options.isDeleteOption!=="n"){if(this.selectedAttachments.length&&this.selectedAttachments.length==1){var t=true;if(this.options.isDeleteOption==="o"){for(var e=0;e<this.selectedAttachments.length;e++){if(this.selectedAttachments[e].data.person!==layout.desktop.session.user.distinguishedName){t=false;break}}}else if(this.options.isDeleteOption==="a"){for(var e=0;e<this.selectedAttachments.length;e++){if(this.selectedAttachments[e].data.activity!==this.module.form.businessData.activity.id){t=false;break}}}else if(this.options.isDeleteOption==="ao"){for(var e=0;e<this.selectedAttachments.length;e++){if(this.selectedAttachments[e].data.activity!==this.module.form.businessData.activity.id||this.selectedAttachments[e].data.person!==layout.desktop.session.user.distinguishedName){t=false;break}}}if(t){this.setActionEnabled(this.deleteAction);this.setActionEnabled(this.min_deleteAction)}else{this.setActionDisabled(this.deleteAction);this.setActionDisabled(this.min_deleteAction)}}else{this.setActionDisabled(this.deleteAction);this.setActionDisabled(this.min_deleteAction)}}else{if(!this.options.isDelete){this.setActionDisabled(this.deleteAction);this.setActionDisabled(this.min_deleteAction)}else{if(this.selectedAttachments.length){this.setActionEnabled(this.deleteAction);this.setActionEnabled(this.min_deleteAction)}else{this.setActionDisabled(this.deleteAction);this.setActionDisabled(this.min_deleteAction)}}}},openInOfficeControl:function(e,i){if(i){if(!i.openedAttachment||i.openedAttachment.id!==e.id){i.save();MWF.Actions.get("x_cms_assemble_control").getAttachmentUrl(e.id,this.module.form.businessData.document.id,function(t){i.openedAttachment={id:e.id,site:this.module.json.name,name:e.name};i.officeOCX.BeginOpenFromURL(t,true,this.readonly)}.bind(this))}}},checkReplaceAction:function(){if(this.options.readonly){this.setActionDisabled(this.replaceAction);this.setActionDisabled(this.min_replaceAction);return false}if(this.options.isReplaceOption!=="y"&&this.options.isReplaceOption!=="n"){if(this.selectedAttachments.length&&this.selectedAttachments.length===1){var t;if(this.options.isReplaceOption==="o"){t=this.selectedAttachments[0].data.person===layout.desktop.session.user.distinguishedName}if(this.options.isReplaceOption==="a"){t=this.selectedAttachments[0].data.activity===this.module.form.businessData.activity.id}if(this.options.isReplaceOption==="ao"){t=this.selectedAttachments[0].data.person===layout.desktop.session.user.distinguishedName&&this.selectedAttachments[0].data.activity===this.module.form.businessData.activity.id}if(t){this.setActionEnabled(this.replaceAction);this.setActionEnabled(this.min_replaceAction)}else{this.setActionDisabled(this.replaceAction);this.setActionDisabled(this.min_replaceAction)}}else{this.setActionDisabled(this.replaceAction);this.setActionDisabled(this.min_replaceAction)}}else{if(!this.options.isReplace){this.setActionDisabled(this.replaceAction);this.setActionDisabled(this.min_replaceAction)}else{if(this.selectedAttachments.length&&this.selectedAttachments.length===1){this.setActionEnabled(this.replaceAction);this.setActionEnabled(this.min_replaceAction)}else{this.setActionDisabled(this.replaceAction);this.setActionDisabled(this.min_replaceAction)}}}},replaceAttachment:function(t,e){var i=this.selectedAttachments[0].data;if(this.module.json.isOpenInOffice&&this.module.json.officeControlName&&this.options.officeFiles.indexOf(i.extension)!==-1){var n=this.module.form.all[this.module.json.officeControlName];if(n){if(this.min_closeOfficeAction)this.setActionEnabled(this.min_closeOfficeAction);if(this.closeOfficeAction)this.setActionEnabled(this.closeOfficeAction);this.openInOfficeControl(i,n)}else{if(this.selectedAttachments.length&&this.selectedAttachments.length==1){if(this.module)this.module.replaceAttachment(t,e,this.selectedAttachments[0])}}}else{if(this.selectedAttachments.length&&this.selectedAttachments.length==1){if(this.module)this.module.replaceAttachment(t,e,this.selectedAttachments[0])}}},createTopNode:function(){if(this.options.title){if(!this.titleNode)this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.options.title}).inject(this.node)}this.topNode=new Element("div",{styles:this.css.topNode}).inject(this.node);this.createEditGroupActions();this.createReadGroupActions();this.createListGroupActions();if(this.module.json.isOpenInOffice&&this.module.json.officeControlName)this.createOfficeGroupActions();this.createViewGroupActions()},createOfficeGroupActions:function(){this.officeActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode);this.officeActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.officeActionBoxNode);this.closeOfficeAction=this.createAction(this.officeActionsGroupNode,"closeOffice",MWF.LP.widget.closeOffice,function(t,e){this.closeAttachmentOffice(t,e)}.bind(this));if(this.closeOfficeAction)this.setActionDisabled(this.closeOfficeAction)},loadMinActions:function(){this.min_uploadAction=this.createAction(this.minActionAreaNode,"upload",MWF.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this));this.min_deleteAction=this.createAction(this.minActionAreaNode,"delete",MWF.LP.widget["delete"],function(t,e){this.deleteAttachment(t,e)}.bind(this));this.min_replaceAction=this.createAction(this.minActionAreaNode,"replace",MWF.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this));this.min_downloadAction=this.createAction(this.minActionAreaNode,"download",MWF.LP.widget.download,function(t,e){this.downloadAttachment(t,e)}.bind(this));if(this.module.json.isOpenInOffice&&this.module.json.officeControlName){this.min_closeOfficeAction=this.createAction(this.minActionAreaNode,"closeOffice",MWF.LP.widget.closeOffice,function(t,e){this.closeAttachmentOffice(t,e)}.bind(this));if(this.min_closeOfficeAction)this.setActionDisabled(this.closeOfficeAction)}this.createSeparate(this.minActionAreaNode);this.sizeAction=this.createAction(this.minActionAreaNode,"max",MWF.LP.widget.min,function(){this.changeControllerSize()}.bind(this))},closeAttachmentOffice:function(){var t=this.module.form.all[this.module.json.officeControlName];if(t){t.openFile();if(this.min_closeOfficeAction)this.setActionDisabled(this.min_closeOfficeAction);if(this.closeOfficeAction)this.setActionDisabled(this.closeOfficeAction)}}});MWF.xApplication.cms.Xform.Attachment=MWF.CMSAttachment=new Class({Extends:MWF.APPAttachment,options:{moduleEvents:["upload","delete","afterDelete","load"]},initialize:function(t,e,i,n){this.node=$(t);this.node.store("module",this);this.json=e;this.form=i;this.field=true},_loadUserInterface:function(){this.node.empty();this.loadAttachmentController();this.fireEvent("load")},loadAttachmentController:function(){var t={title:"附件区域",listStyle:this.json.listStyle||"icon",size:this.json.size||"max",resize:this.json.size=="true"?true:false,attachmentCount:this.json.attachmentCount||0,isUpload:this.json.isUpload=="y"?true:false,isDelete:this.json.isDelete=="y"?true:false,isReplace:this.json.isReplace=="y"?true:false,isDownload:this.json.isDownload=="y"?true:false,isSizeChange:this.json.isSizeChange=="y"?true:false,readonly:this.json.readonly=="y"?true:false,isDeleteOption:this.json.isDelete,isReplaceOption:this.json.isReplace,toolbarGroupHidden:this.json.toolbarGroupHidden||[]};if(this.readonly)t.readonly=true;this.attachmentController=new MWF.xApplication.cms.Xform.AttachmentController(this.node,this,t);this.attachmentController.load();this.form.businessData.attachmentList.each(function(t){if(t.site==this.json.id)this.attachmentController.addAttachment(t)}.bind(this))},loadAttachmentSelecter:function(e,i){MWF.require("MWF.widget.AttachmentSelector",function(){var t={title:"选择附件",listStyle:"icon",selectType:"all",size:"max",attachmentCount:0,isUpload:true,isDelete:true,isReplace:true,isDownload:true,toBase64:true,base64MaxSize:800,readonly:false};t=Object.merge(t,e);if(this.readonly)t.readonly=true;this.attachmentController=new MWF.widget.AttachmentSelector(this.node,this,t);this.attachmentController.load();this.postSelect=i;this.form.businessData.attachmentList.each(function(t){this.attachmentController.addAttachment(t)}.bind(this))}.bind(this))},selectAttachment:function(t,e,i){if(i.length>0){var n=i[i.length-1].data;this.form.documentAction.getAttachmentUrl(n.id,this.form.businessData.document.id,function(i){if(this.attachmentController.options.toBase64){this.form.documentAction.getSubjectAttachmentBase64(n.id,this.attachmentController.options.base64MaxSize,function(t){var e=t.data?"data:image/png;base64,"+t.data.value:null;if(this.postSelect)this.postSelect(i,n,e)}.bind(this))}else{if(this.postSelect)this.postSelect(i,n)}}.bind(this))}},createUploadFileNode:function(){this.attachmentController.doUploadAttachment({site:this.json.id},this.form.documentAction.action,"uploadAttachment",{id:this.form.businessData.document.id},null,function(t){if(t.id){this.form.documentAction.getAttachment(t.id,this.form.businessData.document.id,function(t){if(t.data){this.attachmentController.addAttachment(t.data);this.form.businessData.attachmentList.push(t.data)}this.attachmentController.checkActions();this.fireEvent("upload",[t.data])}.bind(this))}this.attachmentController.checkActions()}.bind(this),function(t){if(t.length){if(t.length+this.attachmentController.attachments.length>this.attachmentController.options.attachmentCount&&this.attachmentController.options.attachmentCount>0){var e=MWF.xApplication.cms.Xform.LP.uploadMore;e=e.replace("{n}",this.attachmentController.options.attachmentCount);this.form.notice(e,"error");return false}}return true}.bind(this))},uploadAttachment:function(t,e){if(window.o2&&window.o2.uploadAttachment){window.o2.uploadAttachment(this.json.id)}else if(window.webkit&&window.webkit.messageHandlers){window.webkit.messageHandlers.uploadAttachment.postMessage({site:this.json.id})}else{this.createUploadFileNode()}},getData:function(){return this.attachmentController.getAttachmentNames()},deleteAttachments:function(t,e,i){var n=[];i.each(function(t){n.push(t.data.name)}.bind(this));var s=this;this.form.confirm("warn",t,MWF.xApplication.cms.Xform.LP.deleteAttachmentTitle,MWF.xApplication.cms.Xform.LP.deleteAttachment+"( "+n.join(", ")+" )",300,120,function(){while(i.length){var t=i.shift();s.deleteAttachment(t)}this.close()},function(){this.close()},null)},deleteAttachment:function(e){this.fireEvent("delete",[e.data]);this.form.documentAction.deleteAttachment(e.data.id,function(t){this.attachmentController.removeAttachment(e);this.attachmentController.checkActions();this.fireEvent("afterDelete",[e.data])}.bind(this))},replaceAttachment:function(t,e,i){if(window.o2&&window.o2.replaceAttachment){window.o2.replaceAttachment(i.data.id,this.json.id)}else if(window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.replaceAttachment){window.webkit.messageHandlers.replaceAttachment.postMessage({id:i.data.id,site:this.json.id})}else{var n=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.replaceAttachmentTitle,MWF.xApplication.process.Xform.LP.replaceAttachment+"( "+i.data.name+" )",350,120,function(){n.replaceAttachmentFile(i);this.close()},function(){this.close()},null)}},createReplaceFileNode:function(e){this.attachmentController.doUploadAttachment({site:this.json.id},this.form.documentAction.action,"replaceAttachment",{id:e.data.id,documentid:this.form.businessData.document.id},null,function(t){this.form.documentAction.getAttachment(e.data.id,this.form.businessData.document.id,function(t){e.data=t.data;e.reload();this.attachmentController.checkActions()}.bind(this))}.bind(this),null)},replaceAttachmentFile:function(t){this.createReplaceFileNode(t)},downloadAttachment:function(t,e,i){if(this.form.businessData.document){i.each(function(t){if(window.o2&&window.o2.downloadAttachment){window.o2.downloadAttachment(t.data.id)}else if(window.webkit&&window.webkit.messageHandlers){window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.id})}else{this.form.documentAction.getAttachmentStream(t.data.id,this.form.businessData.document.id)}}.bind(this))}},openAttachment:function(t,e,i){if(this.form.businessData.document){i.each(function(t){if(window.o2&&window.o2.downloadAttachment){window.o2.downloadAttachment(t.data.id)}else if(window.webkit&&window.webkit.messageHandlers){window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.id})}else{this.form.documentAction.getAttachmentData(t.data.id,this.form.businessData.document.id)}}.bind(this))}},getAttachmentUrl:function(t,e){if(this.form.businessData.document){this.form.documentAction.getAttachmentUrl(t.data.id,this.form.businessData.document.id,e)}},createErrorNode:function(t){var e=new Element("div");var i=new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url("+"/x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e);var n=new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){if(!this.isNotValidationMode){this.isNotValidationMode=true;this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom"));this.node.setStyle("border","1px solid red");this.errNode=this.createErrorNode(t).inject(this.node,"after");this.showNotValidationMode(this.node)}},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if(e.get("MWFtype")=="tab$Content"){if(e.getParent("div").getStyle("display")=="none"){var i=e.getParent("div").getParent("div");var n=i.getPrevious("div");var s=i.getChildren().indexOf(e.getParent("div"));var o=n.getChildren()[s];o.click();e=n.getParent("div")}}this.showNotValidationMode(e)}},validationMode:function(){if(this.isNotValidationMode){this.isNotValidationMode=false;this.node.setStyles(this.node.retrieve("borderStyle"));if(this.errNode){this.errNode.destroy();this.errNode=null}}},validationConfigItem:function(t,e){var i=e.status=="all"?true:t=="publish";if(i){var n=this.getData();var s=e.valueType=="value"?n:n.length;switch(e.operateor){case"isnull":if(!s){this.notValidationMode(e.prompt);return false}break;case"notnull":if(s){this.notValidationMode(e.prompt);return false}break;case"gt":if(s>e.value){this.notValidationMode(e.prompt);return false}break;case"lt":if(s<e.value){this.notValidationMode(e.prompt);return false}break;case"equal":if(s==e.value){this.notValidationMode(e.prompt);return false}break;case"neq":if(s!=e.value){this.notValidationMode(e.prompt);return false}break;case"contain":if(s.indexOf(e.value)!=-1){this.notValidationMode(e.prompt);return false}break;case"notcontain":if(s.indexOf(e.value)==-1){this.notValidationMode(e.prompt);return false}break}}return true},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length){for(var i=0;i<this.json.validationConfig.length;i++){var n=this.json.validationConfig[i];if(!this.validationConfigItem(t,n))return false}}return true}return true},validation:function(t,e){if(!this.validationConfig(t,e))return false;if(!this.json.validation)return true;if(!this.json.validation.code)return true;var i=this.form.Macro.exec(this.json.validation.code,this);if(!i)i=MWF.xApplication.process.Xform.LP.notValidation;if(i.toString()!="true"){this.notValidationMode(i);return false}return true}});