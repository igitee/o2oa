MWF.widget=MWF.widget||{};MWF.widget.chart=MWF.widget.chart||{};MWF.require("MWF.widget.Common",null,false);MWF.require("MWF.widget.chart.d3",null,false);MWF.widget.chart.Line=new Class({Implements:[Options,Events],Extends:MWF.widget.chart.Bar,loadChart:function(){this.rectClass=Math.round(Math.random()*100);var barWidth=this.xScale.bandwidth()/this.barsData.length;this.pointCluster=[];this.textCluster=[];this.lineCluster=[];this.lineGroup=this.group.append("g");this.linePoint=[];this.barsData.each(function(bar,i){var lines=d3.line().x(function(d){return this.xScale(d.name)+this.xScale.bandwidth()/2}.bind(this)).y(function(d){return this.yScale(d.data)}.bind(this)).curve(d3.curveCardinal.tension(.25));var line=this.lineGroup.selectAll(".MWFLine_"+this.rectClass+"_"+i).data([bar]).enter().append("path").attr("d",lines(bar)).attr("stroke",this.colors[i]).attr("fill","none");this.lineCluster.push(line);var point=this.group.selectAll(".MWFBar_"+this.rectClass+"_"+i).data(bar).enter().append("circle").attr("r",5).attr("class",".MWFBar_"+this.rectClass+"_"+i).attr("cx",function(d){return this.xScale(d.name)+this.xScale.bandwidth()/2}.bind(this)).attr("cy",function(d){return this.yScale(d.data)}.bind(this)).attr("stroke",this.colors[i]).attr("fill","#ffffff");this.pointCluster.push(point);var texts=this.group.selectAll(".MWFLineText_"+this.rectClass+"_"+i).data(bar).enter().append("text").text(function(d){return this.options.dataFormat?d3.format(this.options.dataFormat)(d.data):d.text}.bind(this)).attr("x",function(d){var x=MWF.getTextSize(this.options.dataFormat?d3.format(this.options.dataFormat)(d.data):d.text).x;return this.xScale(d.name)+this.xScale.bandwidth()/2-x/2}.bind(this)).attr("y",function(d){return this.yScale(d.data)-10}.bind(this));this.textCluster.push(texts)}.bind(this))},setEvents:function(){var rects=this.group.selectAll("circle");var texts=this.group.selectAll("text");var _self=this;rects.on("mouseover",function(d,i,nodeList){_self.highlight(rects,texts,d,i);this.fireEvent("mouseover",[rects,texts,d,i])}.bind(this)).on("mouseout",function(d,i,nodeList){_self.normal(rects,texts,d,i);this.fireEvent("mouseout",[rects,texts,d,i])}.bind(this)).on("click",function(d,i,nodeList){this.fireEvent("click",[rects,texts,d,i])}.bind(this))},highlight:function(shape,texts,d,i){texts.filter(function(data,idx){return idx==i}).attr("display","block");var rect=shape.filter(function(data,idx){return idx==i});var color=rect.attr("fill");rect.node().store("color",color);rect.attr("r","6");rect.attr("stroke-width","3")},normal:function(shape,texts,d,i){texts.filter(function(data,idx){return idx==i}).attr("display","none");var rect=shape.filter(function(data,idx){return idx==i});var color=rect.node().retrieve("color");rect.attr("fill",color);rect.attr("r","6");rect.attr("stroke-width","1")},transition:function(rects){if(!rects)rects=this.group.selectAll("path");var barWidth=this.xScale.bandwidth()/this.barsData.length;var lines=d3.line().x(function(d,i){return this.xScale(d.name)+i*barWidth+this.xScale.bandwidth()/2}.bind(this)).y(function(d){return this.yScale(d.data)}.bind(this)).curve(d3.curveCardinal.tension(0));rects.transition().delay(function(d,i){return i*this.options.delay}.bind(this)).duration(this.options.duration).ease(d3.easeExpOut).attr("d",function(d){return lines(d)}.bind(this))}});