MWF.widget=MWF.widget||{};MWF.require("MWF.widget.Common",null,false);MWF.widget.AudioRecorder=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",config:{sampleBits:8,sampleRate:44100/6,inputChannels:1,outputChannels:1},visible:true,visualize:true},initialize:function(content,options){this.setOptions(options);this.content=content;if(this.options.visible){this.path=MWF.defaultPath+"/widget/$AudioRecorder/";this.cssPath=MWF.defaultPath+"/widget/$AudioRecorder/"+this.options.style+"/css.wcss";this._loadCss()}COMMON.AjaxModule.loadDom(COMMON.contentPath+"/res/framework/adapter/adapter.js",function(){this.load()}.bind(this))},load:function(){if(this.options.visible&&this.content){this.createLayout();this.createToolbar()}},createLayout:function(){this.node=new Element("div",{styles:this.css.node}).inject(this.content);this.actionNode=new Element("div",{styles:this.css.actionNode}).inject(this.node);if(this.options.visualize){this.visualizeNode=new Element("div",{styles:this.css.visualizeNode}).inject(this.node);var size=this.node.getSize();var actionSize=this.actionNode.getSize();var h=size.y-actionSize.y;this.visualizeNode.setStyles({height:""+h+"px"});this.canvas=new Element("canvas",{width:size.x,height:h}).inject(this.visualizeNode);this.canvasCtx=this.canvas.getContext("2d")}},createToolbar:function(){MWF.require("MWF.widget.Toolbar",function(){this.toolbar=new MWF.widget.Toolbar(this.actionNode,{style:"audio"},this);new Element("div",{MWFnodeid:"record",MWFnodetype:"MWFToolBarOnOffButton",MWFButtonImage:this.path+""+this.options.style+"/icon/record.png",title:MWF.LP.widget.record,MWFButtonAction:"recordAction",MWFButtonText:MWF.LP.widget.record}).inject(this.actionNode);new Element("div",{MWFnodeid:"stop",MWFnodetype:"MWFToolBarButton",MWFButtonDisable:"yes",MWFButtonImage:this.path+""+this.options.style+"/icon/stop.png",title:MWF.LP.widget.stop,MWFButtonAction:"stopAction",MWFButtonText:MWF.LP.widget.stop}).inject(this.actionNode);new Element("div",{MWFnodeid:"",MWFnodetype:"MWFToolBarSeparator"}).inject(this.actionNode);new Element("div",{MWFnodeid:"play",MWFnodetype:"MWFToolBarButton",MWFButtonDisable:"yes",MWFButtonImage:this.path+""+this.options.style+"/icon/play.png",title:MWF.LP.widget.play,MWFButtonAction:"playAction",MWFButtonText:MWF.LP.widget.play}).inject(this.actionNode);new Element("div",{MWFnodeid:"save",MWFnodetype:"MWFToolBarButton",MWFButtonDisable:"yes",MWFButtonImage:this.path+""+this.options.style+"/icon/save.png",title:MWF.LP.widget.save,MWFButtonAction:"saveAction",MWFButtonText:MWF.LP.widget.save}).inject(this.actionNode);new Element("div",{MWFnodeid:"cancel",MWFnodetype:"MWFToolBarButton",MWFButtonImage:this.path+""+this.options.style+"/icon/cancel.png",title:MWF.LP.widget.cancel,MWFButtonAction:"cancelAction",MWFButtonText:MWF.LP.widget.cancel}).inject(this.actionNode);this.toolbar.load()}.bind(this))},saveAction:function(){var data=this.audioData.encodeWAV();this.fireEvent("save",[data]);this.close()},cancelAction:function(){this.fireEvent("cancel");this.close()},close:function(){if(this.context)this.context.close();if(this.node)this.node.destroy();MWF.release(this)},recordAction:function(status,btn){if(btn.status==="on"){this.toolbar.items["stop"].enable();this.toolbar.items["play"].disable();this.toolbar.items["save"].disable();this.toolbar.items["cancel"].disable();this.startRecord()}else{btn.on()}},stopAction:function(){var record=this.toolbar.items["record"];if(record.status==="on"){record.off();this.stopRecord();if(this.audioData){if(this.audioData.buffer.length){this.toolbar.items["play"].enable()}}}this.toolbar.items["save"].enable();this.toolbar.items["cancel"].enable();this.toolbar.items["stop"].disable()},playAction:function(){var record=this.toolbar.items["record"];record.off();record.enable(false);this.toolbar.items["stop"].enable();this.toolbar.items["save"].disable();this.toolbar.items["cancel"].disable();if(!this.audioNode)this.audioNode=new Element("audio",{loop:false});this.audioNode.set("src",window.URL.createObjectURL(this.audioData.encodeWAV()));this.audioNode.addEventListener("ended",function(){this.toolbar.items["save"].enable();this.toolbar.items["cancel"].enable()}.bind(this),true);this.audioNode.play()},stopRecord:function(){this.audioInput.disconnect();if(this.canvas){this.canvasCtx.clearRect(0,0,this.canvas.width,this.canvas.height);if(this.drawVisual)window.cancelAnimationFrame(this.drawVisual);if(this.audioNode){if(!this.audioNode.paused)this.audioNode.pause()}}this.context.suspend()},startRecord:function(){this.loadAudio(function(stream){this.initAudio(stream);this.initAudioData();this.startAudio();this.visualize(stream)}.bind(this))},startAudio:function(){if(this.context.state==="suspended")this.context.resume();if(this.audioData){this.audioData.size=0;this.audioData.buffer=[]}this.audioInput.connect(this.analyser);this.analyser.connect(this.recorder);this.recorder.connect(this.volume);this.volume.connect(this.context.destination);this.volume.gain.value=0},initAudioData:function(){if(!this.audioData){var _self=this;this.audioData={size:0,buffer:[],inputSampleRate:_self.context.sampleRate,inputSampleBits:16,outputSampleRate:_self.options.config.sampleRate,outputSampleBits:_self.options.config.sampleBits,input:function(data){this.buffer.push(new Float32Array(data));this.size+=data.length},compress:function(){var data=new Float32Array(this.size);var offset=0;for(var i=0;i<this.buffer.length;i++){data.set(this.buffer[i],offset);offset+=this.buffer[i].length}var compression=parseInt(this.inputSampleRate/this.outputSampleRate);var length=data.length/compression;var result=new Float32Array(length);var index=0,j=0;while(index<length){result[index]=data[j];j+=compression;index++}return result},encodeWAV:function(){var sampleRate=Math.min(this.inputSampleRate,this.outputSampleRate);var sampleBits=Math.min(this.inputSampleBits,this.outputSampleBits);var bytes=this.compress();var dataLength=bytes.length*(sampleBits/8);var buffer=new ArrayBuffer(44+dataLength);var data=new DataView(buffer);var channelCount=1;var offset=0;var writeString=function(str){for(var i=0;i<str.length;i++){data.setUint8(offset+i,str.charCodeAt(i))}};writeString("RIFF");offset+=4;data.setUint32(offset,36+dataLength,true);offset+=4;writeString("WAVE");offset+=4;writeString("fmt ");offset+=4;data.setUint32(offset,16,true);offset+=4;data.setUint16(offset,1,true);offset+=2;data.setUint16(offset,channelCount,true);offset+=2;data.setUint32(offset,sampleRate,true);offset+=4;data.setUint32(offset,channelCount*sampleRate*(sampleBits/8),true);offset+=4;data.setUint16(offset,channelCount*(sampleBits/8),true);offset+=2;data.setUint16(offset,sampleBits,true);offset+=2;writeString("data");offset+=4;data.setUint32(offset,dataLength,true);offset+=4;if(sampleBits===8){for(var i=0;i<bytes.length;i++,offset++){var s=Math.max(-1,Math.min(1,bytes[i]));var val=s<0?s*32768:s*32767;val=parseInt(255/(65535/(val+32768)));data.setInt8(offset,val,true)}}else{for(var i=0;i<bytes.length;i++,offset+=2){var s=Math.max(-1,Math.min(1,bytes[i]));data.setInt16(offset,s<0?s*32768:s*32767,true)}}return new Blob([data],{type:"audio/wav"})}}}},initAudio:function(stream){if(!this.context){this.context=new(window.AudioContext||window.webkitAudioContext);this.audioInput=this.context.createMediaStreamSource(stream);this.volume=this.context.createGain();var bufferSize=4096;this.recorder=this.context.createScriptProcessor(bufferSize,this.options.config.inputChannels,this.options.config.outputChannels);this.analyser=this.context.createAnalyser();this.recorder.onaudioprocess=function(e){this.recordAudioData(e.inputBuffer.getChannelData(0))}.bind(this)}},recordAudioData:function(data){this.audioData.input(data)},loadAudio:function(callback){if(navigator.getUserMedia){navigator.getUserMedia({audio:true},function(stream){if(callback)callback(stream)},function(error){switch(error.code||error.name){case"PERMISSION_DENIED":case"PermissionDeniedError":MWF.xDesktop.notice("error",{x:"right",y:"top"},"用户拒绝提供信息。",this.node);break;case"NOT_SUPPORTED_ERROR":case"NotSupportedError":MWF.xDesktop.notice("error",{x:"right",y:"top"},"浏览器不支持硬件设备。",this.node);break;case"MANDATORY_UNSATISFIED_ERROR":case"MandatoryUnsatisfiedError":MWF.xDesktop.notice("error",{x:"right",y:"top"},"无法发现指定的硬件设备。",this.node);break;default:MWF.xDesktop.notice("error",{x:"right",y:"top"},"无法打开麦克风。异常信息:"+(error.code||error.name),this.node);break}}.bind(this))}else{MWF.xDesktop.notice("error",{x:"right",y:"top"},"浏览器不支持录音功能。",this.node)}},visualize:function(stream){var WIDTH=this.canvas.width;var HEIGHT=this.canvas.height;this.analyser.fftSize=1024;var bufferLength=this.analyser.frequencyBinCount;var dataArray=new Uint8Array(bufferLength);this.canvasCtx.clearRect(0,0,WIDTH,HEIGHT);var _self=this;function draw(){_self.drawVisual=requestAnimationFrame(draw);_self.analyser.getByteTimeDomainData(dataArray);_self.canvasCtx.fillStyle="rgb(204, 204, 204)";_self.canvasCtx.fillRect(0,0,WIDTH,HEIGHT);_self.canvasCtx.lineWidth=1;_self.canvasCtx.strokeStyle="rgb(0, 0, 0)";_self.canvasCtx.beginPath();var sliceWidth=WIDTH*1/bufferLength;var x=0;for(var i=0;i<bufferLength;i++){var v=dataArray[i]/128;v=v-1;var y=v*30+HEIGHT/2;if(i===0){_self.canvasCtx.moveTo(x,y)}else{_self.canvasCtx.lineTo(x,y)}x+=sliceWidth}_self.canvasCtx.lineTo(_self.canvas.width,_self.canvas.height/2);_self.canvasCtx.stroke()}draw()}});