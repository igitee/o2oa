MWF.xDesktop.requireApp("process.ProcessManager","Explorer",null,false);MWF.xApplication.service.ServiceManager.InvokeExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer,Implements:[Options,Events],options:{style:"default",tooltip:{create:MWF.xApplication.service.ServiceManager.LP.invoke.create,search:MWF.xApplication.service.ServiceManager.LP.invoke.search,searchText:MWF.xApplication.service.ServiceManager.LP.invoke.searchText,noElement:MWF.xApplication.service.ServiceManager.LP.invoke.noInvokeNoticeText}},createTitleElementNode:function(){this.titleElementNode=new Element("div",{styles:this.css.titleElementNode,text:"接口配置"}).inject(this.toolbarNode)},_createElement:function(e){var t=this;var i={onQueryLoad:function(){this.actions=t.app.restActions;this.application=t.app.options.application;this.explorer=t}};this.app.desktop.openApplication(e,"service.InvokeDesigner",i)},_loadItemDataList:function(e){this.app.restActions.listInvoke(e)},_getItemObject:function(e){return new MWF.xApplication.service.ServiceManager.InvokeExplorer.Invoke(this,e)},deleteItems:function(){this.hideDeleteAction();while(this.deleteMarkItems.length){var e=this.deleteMarkItems.shift();if(this.deleteMarkItems.length){e.deleteInvoke()}else{e.deleteInvoke(function(){}.bind(this))}}},keyCopy:function(t){debugger;if(this.selectMarkItems.length){var i=[];var n=0;var s=function(e){if(n>=this.selectMarkItems.length){if(i.length){var t=JSON.encode(i);if(e){e.clipboardData.setData("text/plain",t)}else{window.clipboardData.setData("Text",t)}this.app.notice(this.app.lp.copyed,"success")}}}.bind(this);this.selectMarkItems.each(function(e){this.app.restActions.getInvoke(e.data.id,function(e){e.data.elementType="invoke";i.push(e.data);n++;s(t)}.bind(this),null,false)}.bind(this));if(t)t.preventDefault()}},keyPaste:function(e){var t="";if(e){t=e.clipboardData.getData("text/plain")}else{t=window.clipboardData.getData("Text")}var i=JSON.decode(t);this.pasteItem(i,0)},pasteItem:function(e,t){if(t<e.length){var i=e[t];if(i.elementType==="invoke"){this.saveItemAs(i,function(){t++;this.pasteItem(e,t)}.bind(this),function(){t++;this.pasteItem(e,t)}.bind(this),function(){this.reload()}.bind(this))}else{t++;this.pasteItem(e,t)}}else{this.reload()}},saveItemAs:function(l,d,p,h){this.app.restActions.listInvoke(function(e){var t=1;var i=e.data.filter(function(e){return e.id===l.id});if(i.length){var n=i[0];var s=this.app.lp;var o=this;var a=(new Date).parse(l.lastUpdateTime);var r=(new Date).parse(n.lastUpdateTime);var c="<div>"+s.copyConfirmInfor+"</div>";c+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+s.copySource+" "+n.name+"</div>";c+="<div style='font-size:12px; color: #666666; float: left'>"+n.updateTime+"</div>"+"<div style='color: red; float: right;'>"+(a>=r?"":s.copynew)+"</div></div>";c+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+s.copyTarget+" "+l.name+"</div>";c+="<div style='font-size:12px; color: #666666; float: left;'>"+l.updateTime+"</div>"+"<div style='color: red; float: right;'>"+(a<=r?"":s.copynew)+"</div></div>";this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:c},500,290,[{text:s.copyConfirm_overwrite,action:function(){o.saveItemAsUpdate(n,l,d,p);this.close()}},{text:s.copyConfirm_new,action:function(){o.saveItemAsNew(e,l,d,p);this.close()}},{text:s.copyConfirm_skip,action:function(){this.close();if(d)d()}},{text:s.copyConfirm_cancel,action:function(){this.close();if(h)h()}}])}else{this.saveItemAsNew(e,l,d,p)}}.bind(this),function(){if(p)p()}.bind(this))},saveItemAsUpdate:function(e,t,i,n){t.id=e.id;t.name=e.name;t.alias=e.alias;this.app.restActions.updateInvoke(e.id,t,function(){if(i)i()}.bind(this),function(){if(n)n()}.bind(this))},saveItemAsNew:function(e,t,i,n){var s=t.name;var o=1;while(e.data.some(function(e){return e.name==t.name||e.alias==t.name})){t.name=s+"_copy"+o;t.alias=s+"_copy"+o;o++}t.id="";t.id="";this.app.restActions.createInvoke(t,function(){if(i)i()}.bind(this),function(){if(n)n()}.bind(this))}});MWF.xApplication.service.ServiceManager.InvokeExplorer.Invoke=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer.Item,createActionNode:function(){debugger;this.deleteActionNode=new Element("div",{styles:this.css.deleteActionNode}).inject(this.node);this.deleteActionNode.addEvent("click",function(e){this.deleteItem(e)}.bind(this))},createTextNodes:function(){var e=new Element("div",{styles:this.css.itemTextTitleNode,text:(this.data.enable?"":"(禁用)")+this.data.name,title:this.data.name,events:{click:function(e){this._open(e)}.bind(this)}}).inject(this.node);if(!this.data.enable){e.setStyle("color","#999")}new Element("div",{styles:this.css.itemTextDescriptionNode,text:this.data.description||"",title:this.data.description||""}).inject(this.node);new Element("div",{styles:this.css.itemTextDateNode,text:this.data.updateTime||""}).inject(this.node)},_open:function(e){var t=this;var i={onQueryLoad:function(){this.actions=t.explorer.actions;this.category=t;this.options.id=t.data.id}};this.explorer.app.desktop.openApplication(e,"service.InvokeDesigner",i)},_getIcon:function(){var e=(Math.random()*49).toInt();return"process_icon_"+e+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/processIcon/lnk.png",title:this.data.name,par:'service.InvokeDesigner#{"id": "'+this.data.id+'"}'}},deleteInvoke:function(e){this.explorer.actions.deleteInvoke(this.data.id,function(){this.node.destroy();if(e)e()}.bind(this))}});