this.define("openWork",function(t){var e={onQueryClose:function(){var t=this.page.get("Source_todo");t.reload()}.bind(this)};if(t.completed){e.workCompletedId=t.workCompleted}else{e.workId=t.work}layout.desktop.openApplication(this.event,"process.Work",e);this.event.stopPropagation()});this.define("startWork",function(){var t=Current_Portal_Config["process_app"];var e=Current_Portal_Config["process_id"];var i=new MobileProcessStarter(this.page.app,this);i.load(t,e)});this.define("loadSelectProcessLayout",function(t,e){document.title="选择流程";if(t.indexOf(",")>0){t=t.split(",")}if(e&&e.indexOf(",")>0){e=e.split(",")}var i=new MobileProcessStarter(this.page.app,this);i.loadSelectProcessLayout(t,e)});this.define("loadSelectIdentityLayout",function(t,e){document.title="选择身份";var i=new MobileProcessStarter(this.page.app,this);i.loadSelectIdentityLayout(t,e)});var MobileProcessStarter=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i){this.setOptions(i);this.getLp();this.app=t;this.environment=e;this.orgAction=MWF.Actions.get("x_organization_assemble_control");this.workAction=MWF.Actions.get("x_processplatform_assemble_surface");this.userName=(layout.desktop.session.user||layout.user).distinguishedName},load:function(t,e){this.applactionId=t;this.processId=e;this.checkProcess(t,e)},checkProcess:function(t,i){this.getProcessByAppId(t,function(t){debugger;if(i){i=typeOf(i)=="string"?[i]:i;this.processList=[];for(var e=0;e<t.length;e++){if(i.contains(t[e].id)){this.processList.push(t[e])}}}else{this.processList=t}if(this.processList.length==0){this.app.notice("您没有权限发起流程","error")}else if(this.processList.length==1){this.process=this.processList[0];this.checkIdentity()}else{this.gotoSelectProcessPage()}}.bind(this))},checkIdentity:function(){this.orgAction.getPerson(function(t){this.identityList=t.data.woIdentityList||[];if(this.identityList.length==0){this.app.notice("无法获取您的身份","error")}else if(this.identityList.length==1){this.identity=this.identityList[0];this.startImmedintely()}else{this.gotoSelectIdentityPage()}}.bind(this),null,this.userName)},gotoSelectProcessPage:function(){var t={portalId:"77ef21c3-14a2-4e0b-9449-4c9936aed40f",pageId:"82a5192c-6244-4d52-a8c8-6497d33c6d7c"};var e=new URI(window.location.href);var i=e.getData("redirectlink");if(!i){var s=window.location;var i=encodeURIComponent(s.pathname+s.search)}else{i=encodeURIComponent(i)}var o="/x_desktop/appMobile.html?app=portal.Portal&appid="+this.applactionId;if(this.processId){o=o+"&processId="+this.processId}window.location=o+"&option="+JSON.stringify(t)+"&redirectlink="+i},gotoSelectIdentityPage:function(){var t={portalId:"77ef21c3-14a2-4e0b-9449-4c9936aed40f",pageId:"f3644ba3-ecef-4863-ae61-002cf38468e1"};var e=new URI(window.location.href);var i=e.getData("redirectlink");if(!i){var s=window.location;var i=encodeURIComponent(s.pathname+s.search)}else{i=encodeURIComponent(i)}window.location="/x_desktop/appMobile.html?app=portal.Portal&appid="+this.process.application+"&processId="+this.process.id+"&option="+JSON.stringify(t)+"&redirectlink="+i},loadSelectProcessLayout:function(t,i){this.applactionId=t;this.getProcessByAppId(t,function(t){if(i){i=typeOf(i)=="string"?[i]:i;this.processList=[];for(var e=0;e<t.length;e++){if(i.contains(t[e].id)){this.processList.push(t[e])}}}else{this.processList=t}this.getCss();this.createMarkNode();this.createAreaNode();this.createSelectProcessNode();this.areaNode.inject(this.markNode,"after");this.areaNode.fade("in");this.setStartNodeSize()}.bind(this))},loadSelectIdentityLayout:function(t,s){this.applactionId=t;this.processId=s;this.getProcessByAppId(t,function(t){this.processList=t;for(var e=0;e<t.length;e++){var i=t[e];if(i.id==s){this.orgAction.getPerson(function(t){this.identityList=t.data.woIdentityList||[];this.process=i;this.getCss();this.createMarkNode();this.createAreaNode();this.createSelectIdentityNode();this.areaNode.inject(this.markNode,"after");this.areaNode.fade("in");this.setStartNodeSize()}.bind(this),null,this.userName);return}}}.bind(this))},getProcessByAppId:function(t,e){debugger;var i=t;if(typeOf(i)=="string")i=[i];var s=[];for(var o=0;o<i.length;o++){var n=new this.environment.Action("x_processplatform_assemble_surface",{lookup:{uri:"/jaxrs/process/list/application/"+i[o],method:"GET"}});n.invoke({name:"lookup",parameter:{},data:null,success:function(t){s=s.concat(t.data)}.bind(this),async:false})}if(e)e(s)},createMarkNode:function(){this.markNode=new Element("div#mark",{styles:this.css.markNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.app.content)},createAreaNode:function(){this.areaNode=new Element("div#area",{styles:this.css.areaNode})},createSelectProcessNode:function(){this.createNode=new Element("div",{styles:this.css.createNode}).inject(this.areaNode);this.formNode=new Element("div",{styles:this.css.formNode}).inject(this.createNode);var t='<table width="100%" height="90%" border="0" cellPadding="0" cellSpacing="0">'+'<tr><td colSpan="2" id="form_startProcess"></td></tr>'+"</table>";this.formNode.set("html",t);this.processArea=this.formNode.getElementById("form_startProcess");var i=this;this.processList.each(function(t){var e=new MobileProcessStarter.Process(this.processArea,t,this,this.css);e.node.store("process",e);e.node.addEvents({click:function(){var t=this.retrieve("process");if(t){i.process=t.data;i.checkIdentity()}}})}.bind(this))},createSelectIdentityNode:function(){this.createNode=new Element("div",{styles:this.css.createNode}).inject(this.areaNode);this.formNode=new Element("div",{styles:this.css.formNode}).inject(this.createNode);var t='<table width="100%" height="90%" border="0" cellPadding="0" cellSpacing="0">'+'<tr><td colSpan="2" id="form_startIdentity"></td></tr>'+"</table>";this.formNode.set("html",t);this.identityArea=this.formNode.getElementById("form_startIdentity");var i=this;this.identityList.each(function(t){var e=new MobileProcessStarter.Identity(this.identityArea,t,this,this.css);e.node.store("identity",e);e.node.addEvents({click:function(){var t=this.retrieve("identity");if(t){i.okStartProcess(t.data.distinguishedName)}}})}.bind(this))},setStartNodeSize:function(){var t=this.app.content.getSize();var e=this.app.content.getSize();this.markNode.setStyles({width:""+e.x+"px",height:""+e.y+"px"});this.areaNode.setStyles({width:""+t.x+"px",height:""+t.y+"px"});var i=t.y*.7;var s=t.y*.3/2},cancelStartProcess:function(t){this.markNode.destroy();this.areaNode.destroy()},startImmedintely:function(){var e={title:this.process.name+"-"+"未命名",identity:this.identity.distinguishedName};this.workAction.startWork(function(t){this.afterStartProcess(t.data,e.title,this.process.name)}.bind(this),null,this.process.id,e)},okStartProcess:function(t){var e={title:this.process.name+"-"+this.lp.unnamed,identity:t};if(!e.identity){this.departmentSelArea.setStyle("border-color","red");this.app.notice(this.lp.selectStartId,"error")}else{this.mask=new MWF.widget.Mask({style:"desktop"});this.mask.loadNode(this.areaNode);this.workAction.startWork(function(t){this.mask.hide();this.markNode.destroy();this.areaNode.destroy();this.afterStartProcess(t.data,e.title,this.process.name)}.bind(this),null,this.process.id,e)}},afterStartProcess:function(t,e,i){var s=[];var o=[];t.each(function(t){if(t.currentTaskIndex!==-1)o.push(t.taskList[t.currentTaskIndex].work);s.push(this.getStartWorkInforObj(t))}.bind(this));if(o.length===1){var n={workId:o[0],appId:o[0]};layout.desktop.openApplication(null,"process.Work",n)}},getStartWorkInforObj:function(i){var s=[];var o="";i.taskList.each(function(t,e){s.push(t.person+"("+t.department+")");if(i.currentTaskIndex===e)o=t.id}.bind(this));return{activity:i.fromActivityName,users:s,currentTask:o}},recordProcessData:function(){MWF.UD.getDataJson("taskCenter_startTop",function(t){if(!t||!t.length)t=[];var e=null;this.process.lastStartTime=new Date;var i=0;var s=true;for(var o=0;o<t.length;o++){var n=t[o];if(n.id===this.process.id)e=n;if(s){if(!n.lastStartTime){i=o;s=false}else{if(new Date(n.lastStartTime)<new Date(t[i].lastStartTime)){i=o}}}}if(e){e.lastStartTime=new Date;e.count=(e.count||0)+1;e.applicationName=this.applicationData.name}else{if(t.length<10){this.process.count=1;this.process.applicationName=this.applicationData.name;t.push(this.process)}else{t.splice(i,1);this.process.count=1;this.process.applicationName=this.applicationData.name;t.push(this.process)}}MWF.UD.putData("taskCenter_startTop",t)}.bind(this))},getLp:function(){this.lp={name:"姓名",unit:"部门",start:"启动流程",department:"部门",company:"公司",duty:"职务",identity:"身份",date:"时间",subject:"文件标题",process:"流程",cancel:"取消",ok:"确定",startProcess_cancel_title:"取消启动流程确认",startProcess_cancel:"您确定要取消启动流程吗？",inputProcessSubject:"请输入文件标题",selectStartId:"请选择启动部门，以确定启动者身份",processStarted:"流程已启动",unnamed:"无标题",selectStartIdentity:"请选择您的身份"}},getCss:function(){this.css={markNode:{opacity:1,position:"absolute","background-color":"#f5f5f5",top:"0px",left:"0px"},areaNode:{position:"absolute",opacity:0,top:"0px"},createNode:{"background-color":"#f5f5f5",width:"100%",overflow:"auto"},createNewNode:{},createCloseNode:{width:"47px",height:"47px",float:"right",cursor:"pointer",background:"url("+"/x_component_process_TaskCenter/$ProcessStarter/default/close.png) center center no-repeat"},formNode:{"border-radius":"8px",border:"0px solid #666",width:"100%",margin:"0px auto","font-size":"16px",color:"#666",overflow:"hidden","font-family":"微软雅黑"},actionNode:{width:"280px",margin:"auto",overflow:"hidden"},startOkActionNode:{height:"30px",width:"85px",cursor:"pointer",float:"right","line-height":"30px","padding-left":"65px","font-size":"16px","font-family":"微软雅黑","border-radius":"3px",border:"1px solid #354f67",color:"#FFF","margin-right":"20px","margin-top":"20px","margin-bottom":"20px","box-shadow":"0px 0px 0px #666",background:"url("+"/x_component_process_TaskCenter/$ProcessStarter/default/editOk_bg.png) no-repeat"},cancelActionNode:{height:"30px",width:"60px",cursor:"pointer",float:"right","line-height":"30px","padding-left":"40px","font-size":"16px","font-family":"微软雅黑","border-radius":"3px",color:"#FFF","margin-top":"20px","margin-bottom":"20px","box-shadow":"0px 0px 0px #666",border:"1px solid #999",background:"url("+"/x_component_process_TaskCenter/$ProcessStarter/default/editCancel_bg.png) no-repeat"},departSelNode:{padding:"5px","margin-right":"10px",float:"left","background-color":"#DDD","border-radius":"3px",color:"#000",cursor:"pointer"},departSelNode_over:{"background-color":"#fecfb7"},departSelNode_out:{"background-color":"#EEE"},departSelNode_selected:{"background-color":"#ea621f",color:"#FFF"},identityNode:{overflow:"hidden",width:"80%",border:"1px solid #eee","border-radius":"8px","background-color":"#FFF",cursor:"pointer","font-size":"14px",padding:"10px",margin:"20px auto","box-shadow":"0px 0px 10px #ddd"},identityNode_over:{border:"1px solid #da7429"},identityInforNameNode:{height:"50px","margin-bottom":"5px"},identityInforPicNode:{height:"50px",width:"50px","border-radius":"25px",overflow:"hidden",float:"left"},identityInforNameTextNode:{height:"40px","line-height":"40px",overflow:"hidden",float:"left","margin-left":"10px","margin-right":"30px",width:"150px",color:"#666","font-size":"14px","font-weight":"bold","text-align":"center"},identityInforNameTextNode_over:{color:"#da7429"},identityDepartmentNode:{height:"26px","line-height":"26px",overflow:"hidden"},identityCompanyNode:{height:"26px","line-height":"26px",overflow:"hidden"},identityDutyNode:{height:"22px","line-height":"22px",overflow:"hidden"},identityTitleNode:{color:"#666",width:"50px","padding-left":"10px",float:"left"},identityTitleNode_over:{color:"#da7429"},identityTextNode:{color:"#333","margin-left":"50px","text-align":"left"},processNode:{overflow:"hidden",width:"80%",border:"1px solid #eee","border-radius":"8px","background-color":"#FFF",cursor:"pointer","font-size":"14px",padding:"10px",margin:"30px auto","box-shadow":"0px 0px 10px #ddd"},processItemNode:{height:"50px","line-height":"50px",overflow:"hidden"},processTitleNode:{color:"#666",width:"50px","padding-left":"10px",float:"left"},processTextNode:{color:"#333","margin-left":"50px","text-align":"left"}}}});MobileProcessStarter.Process=new Class({initialize:function(t,e,i,s){this.container=$(t);this.data=e;this.starter=i;this.action=this.starter.orgAction;this.lp=i.lp;this.style=s;this.load()},load:function(){this.node=new Element("div",{styles:this.style.processNode}).inject(this.container);var t=new Element("div",{styles:this.style.processItemNode}).inject(this.node);var e=new Element("div",{styles:this.style.processTitleNode,text:"流程"}).inject(t);e.setStyle("font-size","16px");this.textNode=new Element("div",{styles:this.style.processTextNode,text:this.data.name}).inject(t);this.textNode.setStyle("font-size","16px")}});MobileProcessStarter.Identity=new Class({initialize:function(t,e,i,s){this.container=$(t);this.data=e;this.starter=i;this.action=this.starter.orgAction;this.lp=i.lp;this.style=s;this.load()},load:function(){this.node=new Element("div",{styles:this.style.identityNode}).inject(this.container);var t=new Element("div",{styles:this.style.identityDutyNode}).inject(this.node);var e=new Element("div",{styles:this.style.identityTitleNode,text:this.lp.name}).inject(t);this.unitTextNode=new Element("div",{styles:this.style.identityTextNode,text:this.data.name}).inject(t);var i=new Element("div",{styles:this.style.identityDepartmentNode}).inject(this.node);var s=new Element("div",{styles:this.style.identityTitleNode,text:this.lp.unit}).inject(i);this.unitTextNode=new Element("div",{styles:this.style.identityTextNode}).inject(i);if(this.data.woUnit)this.unitTextNode.set({text:this.data.woUnit.levelName,title:this.data.woUnit.levelName});var o=new Element("div",{styles:this.style.identityDutyNode}).inject(this.node);var n=new Element("div",{styles:this.style.identityTitleNode,text:this.lp.duty}).inject(o);this.dutyTextNode=new Element("div",{styles:this.style.identityTextNode}).inject(o);var r=[];var a=[];this.data.woUnitDutyList.each(function(t){r.push(t.name);if(t.woUnit)a.push(t.name+"("+t.woUnit.levelName+")")}.bind(this));this.dutyTextNode.set({text:r.join(", "),title:a.join(", ")})}});