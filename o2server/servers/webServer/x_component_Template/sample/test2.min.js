MWF.xDesktop.requireApp("Template","MPopupForm",null,false);MWF.xDesktop.requireApp("cms.Module","ExcelForm",null,false);this.define("dipatchNumberToCity",function(){var i=this.getSelectedId();if(i.length==0){this.form.app.notice("先选择号码","error");return}var t=this.getLevel1Unit();var e=[];t.each(function(t){e.push({name:t.name,id:t.distinguishedName})});MWF.xDesktop.requireApp("Template","Selector.Custom",null,false);var n={count:1,title:"选择分配的组织",selectableItems:e,values:[],onComplete:function(t){if(!t||t.length==0)return;var e=t[0].data.id;if(!e)return;this.saveDocList(i,e,"","")}.bind(this)};var r=new MWF.xApplication.Template.Selector.Custom(this.form.app.content,n);r.load()}.bind(this));this.define("dipatchNumberToCounty",function(i,t){var r=this.getSelectedId();if(r.length==0){this.form.app.notice("先选择号码","error");return}var e=[];if(i){var n=this.org.listSubUnit(i,false);n.each(function(t){e.push({name:t.name,id:t.distinguishedName})})}if(i){MWF.xDesktop.requireApp("Template","Selector.Custom",null,false);var o={count:1,title:"选择分配的组织",selectableItems:e,values:[],onComplete:function(t){if(!t||t.length==0)return;var e=t[0].data.id;this.saveDocList(r,i,e,"")}.bind(this)};var s=new MWF.xApplication.Template.Selector.Custom(this.form.app.content,o);s.load()}else{MWF.xDesktop.requireApp("Selector","package",null,false);var o={count:1,title:"选择分配的组织",type:"unit",values:[],onComplete:function(t){if(!t||t.length==0)return;var e=t[0].data.distinguishedName;debugger;var i=t[0].data.levelName;if(i.split("/").length!=2){this.form.app.notice("请选择县级分公司","error");return false}this.getAllUnit();var n=this.name_dnName[i.split("/")[0]];this.saveDocList(r,n,e,"")}.bind(this)};if(t)o.units=[t];var s=new MWF.O2Selector(this.form.app.content,o)}}.bind(this));this.define("dipatchNumberToBranch",function(r,t){var o=this.getSelectedId();if(o.length==0){this.form.app.notice("先选择号码","error");return}var e=[];if(r){var i=this.org.listSubUnit(r,false);i.each(function(t){e.push({name:t.name,id:t.distinguishedName})})}if(r){MWF.xDesktop.requireApp("Template","Selector.Custom",null,false);var n={count:1,title:"选择分配的组织",selectableItems:e,values:[],onComplete:function(t){if(!t||t.length==0)return;var e=t[0].data.id;this.getAllUnit();var i=this.dnName_levelName[e];if(i.split("/").length!=3){this.form.app.notice("请选择网格","error");return false}var n=this.name_dnName[i.split("/")[0]];this.saveDocList(o,n,r,e)}.bind(this)};var s=new MWF.xApplication.Template.Selector.Custom(this.form.app.content,n);s.load()}else{MWF.xDesktop.requireApp("Selector","package",null,false);var n={count:1,title:"选择分配的组织",type:"unit",values:[],onComplete:function(t){if(!t||t.length==0)return;var e=t[0].data.distinguishedName;debugger;this.getAllUnit();var i=this.dnName_levelName[e];if(i.split("/").length!=3){this.form.app.notice("请选择网格","error");return false}var n=this.name_dnName[i.split("/")[0]];var r=this.name_dnName[i.split("/")[1]];this.saveDocList(o,n,r,e)}.bind(this)};if(t)n.units=[t];var s=new MWF.O2Selector(this.form.app.content,n)}}.bind(this));this.define("saveDocList",function(e,n,r,o){e.each(function(t){debugger;var e=this.form.selectedItemJson[t];var i={docStatus:"published",city:n,county:r,branch:o};if(!this.form.statJson){this.form.statJson=new StatJson(this)}this.form.statJson.changeData(i,e,e.batch);this.form.statJson.submit()}.bind(this));if(this.form.currentView.docStatus=="error"){var i=0;e.each(function(t){this.saveDoc(t,n,r,o,function(){i++;if(i==e.length){this.setUploadedUnit(function(){this.form.app.notice("分配成功","");this.createImportBatchDiv();this.loadStatTable(this.statTableOptions?this.statTableOptions.container:this.form.get("statContaienr").node);this.form.view.reload();this.form.view.selectedItems=[];if(this.form.view_error){this.form.view_error.reload();this.form.view_error.selectedItems=[]}}.bind(this))}}.bind(this))}.bind(this))}else{this.saveDcc(e,["city","county","branch"],[n,r,o],function(){this.setUploadedUnit(function(){this.form.app.notice("分配成功","");this.createImportBatchDiv();this.loadStatTable(this.statTableOptions?this.statTableOptions.container:this.form.get("statContaienr").node);this.form.currentView.reload();this.form.currentView.selectedItems=[]}.bind(this))}.bind(this))}}.bind(this));this.define("saveDoc",function(t,i,n,r,o){MWF.Actions.get("x_cms_assemble_control").getDocument(t,function(t){var e=t.data;e.data.city=i;e.data.county=n;e.data.branch=r;e.data.errorText="";e.data.docStatus="published";e.data.status="成功";e.data.title=e.data.subject;delete e.data.$document;delete e.document.viewCount;delete e.document.publishTime;delete e.document.hasIndexPic;delete e.document.readPersonList;delete e.document.readUnitList;delete e.document.readGroupList;delete e.document.authorPersonList;delete e.document.authorUnitList;delete e.document.authorGroupList;delete e.document.managerList;delete e.document.pictureList;delete e.documentLogList;delete e.isAppAdmin;delete e.isCategoryAdmin;delete e.isManager;delete e.isCreator;delete e.isEditor;e.document.docData=e.data;delete e.data;e.document.docStatus="published";e.document.subject=e.document.title;MWF.Actions.get("x_cms_assemble_control").updateDocument(e.document,function(){if(o)o()}.bind(this))}.bind(this))}.bind(this));this.define("dipatchNumber",function(){var i=this.getSelectedId();if(i.length==0){this.form.app.notice("先选择号码","error");return}var t=this.getSubUnit();if(t){MWF.xDesktop.requireApp("Template","Selector.Custom",null,false);var e={count:1,title:"选择分配的组织",selectableItems:t,values:[],onComplete:function(t){if(!t||t.length==0)return;var e=t[0].data.id;this.setUnit(i,e)}.bind(this)};var n=new MWF.xApplication.Template.Selector.Custom(this.form.app.content,e);n.load()}else{MWF.xDesktop.requireApp("Selector","package",null,false);var e={count:1,title:"选择分配的组织",type:"unit",values:[],onComplete:function(t){if(!t||t.length==0)return;var e=t[0].data.distinguishedName;debugger;this.setUnit(i,e)}.bind(this)};var n=new MWF.O2Selector(this.form.app.content,e)}});this.define("getSelectedId",function(){var e=[];if(!this.form.currentView){this.form.currentView=this.form.view}this.form.selectedItemJson={};this.form.currentView.selectedItems.each(function(t){e.push(t.data.bundle);this.form.selectedItemJson[t.data.bundle]={batch:t.data.data.batch,city:t.data.data.city,county:t.data.data.county,branch:t.data.data.branch,docStatus:this.form.currentView.docStatus||"published"}}.bind(this));return e});this.define("getSubUnit",function(){var t=this.data.currentUnit;if(t){var e=this.org.listSubUnit(t,false)}else if(!this.data.newFlag){var e=this.getLevel1Unit()}else{return null}var i=[];e.each(function(t){i.push({name:t.name,id:t.distinguishedName})});return i});this.define("getLevel1Unit",function(e){var i=[];var t=new this.Action("x_organization_assemble_express",{lookup:{uri:"/jaxrs/unit/list/level/object",method:"POST"}});t.invoke({name:"lookup",parameter:{},data:{levelList:["1"]},success:function(t){i=t.data;if(e)e(t)}.bind(this),async:false});return i}.bind(this));this.define("setUnit",function(t,i){debugger;if(!i)return;var e=this.data.flag||this.data.newFlag;var n;if(!e){n="city"}else if(e=="city"){n="county"}else if(e=="county"){n="branch"}this.saveDcc(t,n,i,function(){debugger;var t=this.data[n+"TaskPerson"];var e=[];(t.length?t:[]).each(function(t){e.push(typeOf(t)=="string"?t:t.distinguishedName)}.bind(this));e.push(i);e=e.unique();this.data[n+"TaskPerson"]=e;this.form.app.notice("分配成功","");this.form.save();this.form.view.reload();this.form.view.selectedItems=[]}.bind(this))});this.define("saveDcc",function(t,e,i,n){var r=new this.Action("x_cms_assemble_control",{save:{uri:"/jaxrs/document/batch/data/modify",method:"PUT"}});var o=[];if(typeOf(e)=="array"){for(var s=0;s<e.length;s++){o.push({dataPath:e[s],dataType:"String",dataString:i[s],dataInteger:null,dataBoolean:null,dataDate:null})}}else{o.push({dataPath:e,dataType:"String",dataString:i,dataInteger:null,dataBoolean:null,dataDate:null})}r.invoke({name:"save",data:{docIds:t,dataChanges:o},success:function(t){if(n)n(t)}.bind(this)})}.bind(this));MWF.require("MWF.xDesktop.Actions.RestActions",null,false);var ChannelTaskPhoneService=new Class({Extends:MWF.xDesktop.Actions.RestActions,initialize:function(t,e){this.context=t;this.serviceUrl="http://localhost:8080/channeltask/";this.importUrl=this.serviceUrl+"import";this.phoneUrl=this.serviceUrl+"phone";this.importcheckUrl=this.serviceUrl+"importcheck"},import:function(t,e,i,n,r){this.invoke({method:"POST",uri:this.importUrl,async:r,enctype:"formdata",data:t,file:e,withCredentials:true,success:function(t){if(i)i(t)},failure:function(){}});if(n){window.setTimeout(function(){this.importcheck(n)}.bind(this),1e3)}},importcheck:function(e){this.invoke({method:"GET",uri:this.importUrl+"?workId"+this.workId,async:true,withCredentials:true,success:function(t){if(e)e(t)},failure:function(){}})},listByImportbatchName:function(t,e,i,n,r){this.phoneAction("list",{importbatchName:t,start:e,end:i,docStatus:n},r)},listByWork:function(t,e,i,n){this.phoneAction("list",{workId:this.workId,start:t,end:e,docStatus:i},n)},listByWorkAndCity:function(t,e,i,n,r){this.phoneAction("list",{workId:this.workId,city:t,start:e,end:i,docStatus:n},r)},listByWorkAndCounty:function(t,e,i,n,r){this.phoneAction("list",{workId:this.workId,county:t,start:e,end:i,docStatus:n},r)},listByWorkAndBranch:function(t,e,i,n,r){this.phoneAction("list",{workId:this.workId,branch:t,start:e,end:i,docStatus:n},r)},deleteByImportbatchName:function(t,e){this.phoneAction("delete",{importbatchName:t},e)},deleteByWorkId:function(t){this.phoneAction("delete",{workId:this.workId},t)},dispatch:function(t,e,i,n,r){this.phoneAction("dispatch",{workId:this.workId,branch:t,start:e,end:i,docStatus:n},r)},phoneAction:function(t,e,i){var n="";for(var r in e){if(e[r])n=n+"&"+r+"="+e[r]}this.invoke({method:"GET",uri:this.phoneUrl+"?action="+t+n,async:true,withCredentials:true,success:function(t){if(i)i(t)},failure:function(){}})},invoke:function(t){var e=t.method||"GET";var i=t.uri;var n=t.async===false?false:true;var r=new MWF.xDesktop.Actions.RestActions.Callback(t.success,t.failure);if(t.enctype&&t.enctype.toLowerCase()=="formdata"){this.invokeFormData(e,i,t.data,t.file,r,n)}else{var o=t.data?JSON.encode(t.data):"";var s=true;if(t.withCredentials===false){s=false}return MWF.restful(e,i,o,r,n,s)}}});var UploadExcelDialog=new Class({Extends:MWF.xApplication.cms.Module.ImportForm,Implements:[Options,Events],options:{style:"minder",width:"650",height:"430",hasTop:true,hasIcon:false,draggable:true,maxAction:true,title:"导入号码"},_createTableContent:function(){this.formTableContainer.setStyles({margin:"0px auto 20px atuo"});var t="<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='margin-top: 20px; '>"+"<tr><td styles='formTableTitle' width='20%'>说明：</td>"+"    <td styles='formTableValue' colspan='3' width='80%' style='font-size:12px;color:#666;line-height:20px;'>"+"       您可以直接在Excel表格里填写地市分公司、区县分公司和网格的名称，系统会以您导入的分公司名称进行流转分发。<br/>"+"请注意填写的名称需要与系统内的分公司/组织名称一致。<div item='openUnit''></div>"+"<div item='url2'></div>"+"</td></tr>"+"<tr><td styles='formTableTitle' lable='url' width='20%'></td>"+"    <td styles='formTableValue' item='url' colspan='3' width='80%'></td></tr>"+"<tr><td styles='formTableTitle' lable='file' ></td>"+"    <td styles='formTableValue' colspan='3'><div item='filename'></div><div item='file'></div></td></tr>"+"</table>";this.formTableArea.set("html",t);MWF.xDesktop.requireApp("Template","MForm",null,false);this.form=new MForm(this.formTableArea,{},{isEdited:true,style:"cms",hasColon:true,itemTemplate:{openUnit:{type:"Innerhtml",value:"<a href='javascript:void(0)'>点击查看组织名称</a>",event:{click:function(t,e){debugger;layout.desktop.openApplication(e,"Org",{onQueryLoad:function(){this.status={navi:0}}})}.bind(this)}},url2:{type:"Innerhtml",text:"下载模板",value:"<a target='_blank' href='/x_component_cms_Module/$ExcelForm/"+encodeURIComponent("Excel导入合法性说明.xls")+"'>点击查看校验说明</a>"},url:{type:"Innerhtml",text:"下载模板",value:"<a target='_blank' href='/x_component_cms_Module/$ExcelForm/"+encodeURIComponent("Excel模板下载.xls")+"'>Excel模板下载</a>"},file:{type:"button",value:"选择Excel文件",text:"选择文件",event:{click:function(){this.selectFile()}.bind(this)}}}},this.app);this.form.load()},_setCustom:function(){this.formBottomNode.setStyles({margin:"0px auto 0px auto",width:"300px"})},ok:function(t){if(!this.formData){this.app.notice("请先选择Excel文件","error")}else{var e=layout.desktop.session.user;var i=e.identityList&&e.identityList.length>0?e.identityList[0]:{};var n={workName:this.data.workName,workId:this.data.workId,jobId:this.data.jobId,creatorPerson:e.distinguishedName,creatorIdentity:i.distinguishedName,creatorUnitName:i.unitLevelName.replace(/[\/]/,"^^")};if(!this.isSetData){for(var r in n){this.formData.append(r,n[r])}this.isSetData=true}this.loadProgressBar();var o=function(t){var e=this.context.form;this.progressBar.setProgress(js.data.processTotal,js.data.dataTotal,"正在导入数据");var i=this.context.data.importBatchNames?this.context.data.importBatchNames.split(","):[];i.push(n.data.importBatchName);this.context.data.importBatchNames=i.toString();this.context.form.save();this.progressBar.gotoStep(3);this.setResult();if(!e.statJson){e.statJson=new StatJson(this.context)}e.statJson.addBatch(importBatchName,true);e.statJson.submit();this.context.setUploadedUnit(function(){e.view.reload();e.view.selectedItems=[];if(e.view_error){e.view_error.reload();e.view_error.selectedItems=[]}this.context.createImportBatchDiv();this.context.loadStatTable(this.context.statTableOptions?this.context.statTableOptions.container:this.context.form.get("statContaienr").node)}.bind(this));this.formData=null;this.file=null}.bind(this);var s=function(t){this.progressBar.setProgress(js.data.processTotal,js.data.dataTotal,"正在导入数据")}.bind(this);var a=new ChannelTaskPhoneService(this.context,this.data.workId);a.import(this.formData,this.file,o,s,true)}},setResult:function(){this.formTableArea.empty();this.formTopCloseActionNode.setStyle("display","");this.formTopTextNode.set("text","导入结束");var t=this.importedResultJson.data;new Element("div",{styles:{"margin-top":"10px","font-size":"14px","margin-left":"10px"},text:"本批次共导入"+t.dataTotal+"条数据,成功导入"+t.successTotal+"条数据,发生错误"+t.errorTotal+"条"}).inject(this.formTableArea);if(!this.context.form.statJson){this.context.form.statJson=new StatJson(this.context)}this.context.form.statJson.loadTable(this.formTableArea,this.importBatchName);this.setFormNodeSize()},loadProgressBar:function(){this.formTableArea.empty();this.formBottomNode.setStyle("display","none");this.formTopCloseActionNode.setStyle("display","none");this.formTopTextNode.set("text","正在导入数据，请不要关闭窗口...");this.progressBar=new ProgressBar(this.formTableArea);this.progressBar.load()}});this.define("setNumberCount",function(){if(this.data.currentUnit){if(!this.form.statJson){this.form.statJson=new StatJson(this)}var t=this.form.statJson.getUnitCount(this.data.currentUnit);if(this.data.numberCount!=t){this.data.numberCount=t;this.form.save()}}}.bind(this));this.define("getErrorCount",function(){if(!this.form.statJson){this.form.statJson=new StatJson(this)}return this.form.statJson.getErrorCount()}.bind(this));this.define("setUploadedUnit",function(t){if(!this.form.statJson){this.form.statJson=new StatJson(this)}var e=this.data.currentUnit;if(e==""&&!this.data.newFlag){var i=this.workContext.getWork().creatorUnitLevelName;if(i){var n=i.split("/")[0];var e=this.org.getUnit(n)}}var r=this.data.flag||this.data.newFlag;debugger;var o=[];if(!r){o=this.form.statJson.getCity();this.data.numberCount=this.form.statJson.getUnitCount()}else if(r=="city"){if(e){o=this.form.statJson.getCounty(e);this.data.numberCount=this.form.statJson.getUnitCount(e)}else{this.data.numberCount=this.form.statJson.getUnitCount();o=this.form.statJson.getAllCounty()}}else if(r=="county"){if(e){var s=this.data.city;if(!s){var i=this.workContext.getWork().creatorUnitLevelName;if(i){var n=i.split("/")[0];s=this.org.getUnit(n)}else{var n=this.org.listSupUnit(e);s=n[0].distinguishedName}}this.data.numberCount=this.form.statJson.getUnitCount(e);o=this.form.statJson.getBranch(s,e)}else{this.data.numberCount=this.form.statJson.getUnitCount();o=this.form.statJson.getAllBranch()}}debugger;var a;if(!r){a="city"}else if(r=="city"){a="county"}else if(r=="county"){a="branch"}this.data[a+"TaskPerson"]=o;this.form.save(function(){if(t)t()})});this.define("loadView",function(e,i){var t=this.data.provinceWorkId||this.data.cityWorkId||this.data.countyWorkId;var n=this.data.currentUnit;if(n==""&&!this.data.newFlag){n=this.workContext.getWork().creatorUnitLevelName.split("/")[0]}var r=this.data.flag||this.data.newFlag;var o=this.workContext.getControl();var s;if(e=="published"){s="手机号码-导入成功"}else if(e=="error"){s="手机号码-导入失败"}else{s="手机号码"}var a={application:"渠道-手机号码设置",viewName:s,isTitle:"yes",select:o.allowSave?"multi":"none",isExpand:"no",filter:[{logic:"and",path:"workId",title:"workId",comparison:"equals",comparisonTitle:"等于",value:t,formatType:"textValue"}]};if(r&&n){a.filter.push({logic:"and",path:r,title:r,comparison:"equals",comparisonTitle:"等于",value:n,formatType:"textValue"})}var l;if(e=="published"){l=this.form.get("view_container_published").node}else if(e=="error"){l=this.form.get("view_container_error").node}else{l=this.form.get("view_container").node}MWF.xDesktop.requireApp("query.Query","Viewer",function(){var t=new MWF.xApplication.query.Query.Viewer(l,a,{resizeNode:true,onSelect:function(){}.bind(this)});if(e=="published"){t.docStatus="published";this.form.view=t}else if(e=="error"){t.docStatus="error";this.form.view_error=t}else{this.form.view=t}if(i)this.form.currentView=t}.bind(this))});this.define("createImportBatchDiv",function(){if(!this.data.importBatchNames)return;if(!this.form.statJson){this.form.statJson=new StatJson(this)}var c=this;var t=this.form.get("importBatchDiv").node;t.empty();var f={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center"};var p=new Element("table",{width:"90%",border:"0",cellpadding:"5",cellspacing:"0",styles:{"border-top":"1px solid #ccc","border-left":"1px solid #ccc",margin:"20px auto 10px auto"}}).inject(t);var e=new Element("tr").inject(p);new Element("th",{styles:f,text:"导入时间"}).inject(e);new Element("th",{styles:f,text:"校验通过条数"}).inject(e);new Element("th",{styles:f,text:"校验未通过条数"}).inject(e);new Element("th",{styles:f,text:"操作"}).inject(e);this.data.importBatchNames.split(",").each(function(t){var e=t.split("_")[1];var i=e.substring(0,4);var n=e.substring(4,6);var r=e.substring(6,8);var o=e.substring(8,10);var s=e.substring(10,12);var a=e.substring(12,14);var l=i+"-"+n+"-"+r+" "+o+":"+s+":"+a;var u=new Element("tr").inject(p);new Element("td",{styles:f,text:l}).inject(u);new Element("td",{styles:f,text:this.form.statJson.getPublishedCount(t)}).inject(u);new Element("td",{styles:f,text:this.form.statJson.getErrorCount(t)}).inject(u);var d=new Element("td",{styles:f}).inject(u);var h=new Element("button",{styles:{"border-radius":"5px",border:"1px solid rgb(204, 204, 204)",height:"26px",color:"rgb(119, 119, 119)",cursor:"pointer","margin-right":"20px"},text:"只查看该批次导入的数据"}).inject(d);h.store("data",t);h.addEvent("click",function(t){var e=t.target;var i={logic:"and",path:"$document.importBatchName",title:"workId",comparison:"equals",comparisonTitle:"等于",value:e.retrieve("data"),formatType:"textValue"};if(this.form.view){var n=this.form.view;var r=n.json.filter?n.json.filter.clone():[];r.push(i);var o={filterList:r};n.createViewNode(o)}if(this.form.view_error){var s=this.form.view_error;var r=s.json.filter?s.json.filter.clone():[];r.push(i);var o={filterList:r};s.createViewNode(o)}this.loadStatTable(this.statTableOptions?this.statTableOptions.contaier:this.form.get("statContaienr").node,e.retrieve("data"))}.bind(this));var h=new Element("button",{styles:{"border-radius":"5px",border:"1px solid rgb(204, 204, 204)",height:"26px",color:"rgb(119, 119, 119)",cursor:"pointer"},text:"删除该批次导入的数据"}).inject(d);h.store("data",t);h.store("time",l);h.addEvent("click",function(i){this.form.app.confirm("infor",i,"删除确认","删除后无法恢复，确定要删除"+i.target.retrieve("time")+"导入的数据？",380,150,function(){MWF.Actions.get("x_cms_assemble_control").deleteDocumentWithBatchName(i.target.retrieve("data"),function(){var t=c.data.importBatchNames.split(",");var e=i.target.retrieve("data");c.form.statJson.deleteBatch(e);c.form.statJson.submit();t.erase(e);c.data.importBatchNames=t.toString();c.form.save(function(){c.setUploadedUnit(function(){c.form.app.notice("删除成功");c.form.loadErrorView=false;c.form.app.refresh()})})});this.close()},function(){this.close()})}.bind(this))}.bind(this));var e=new Element("tr").inject(p);new Element("td",{styles:f,text:"总数"}).inject(e);new Element("td",{styles:f,text:this.form.statJson.getPublishedCount()}).inject(e);new Element("td",{styles:f,text:this.form.statJson.getErrorCount()}).inject(e);var i=new Element("td",{styles:f}).inject(e);var n=new Element("button",{styles:{"border-radius":"5px",border:"1px solid rgb(204, 204, 204)",height:"26px",color:"rgb(119, 119, 119)",cursor:"pointer","margin-right":"20px"},text:"查看全部"}).inject(i);n.addEvent("click",function(t){var e=t.target;if(this.form.view){var i=this.form.view;var n=i.json.filter?i.json.filter.clone():[];var r={filterList:n};i.createViewNode(r)}if(this.form.view_error){var o=this.form.view_error;var n=o.json.filter?o.json.filter.clone():[];var r={filterList:n};o.createViewNode(r)}this.loadStatTable(this.statTableOptions?this.statTableOptions.contaier:this.form.get("statContaienr").node)}.bind(this))});this.define("getAllUnit",function(e){if(this.name_all){if(e)e()}var i=this.name_all=[];this.name_levelName={};this.dnName_levelName={};this.name_dnName={};var t=new this.Action("x_organization_assemble_express",{lookup:{uri:"/jaxrs/unit/list/all/object",method:"GET"}});t.invoke({name:"lookup",parameter:{},data:null,success:function(t){t.data.each(function(t){this.name_levelName[t.name]=t.levelName;this.dnName_levelName[t.distinguishedName]=t.levelName;this.name_dnName[t.name]=t.distinguishedName;i.push(t.name);i.push(t.distinguishedName);i.push(t.shortName);i.push(t.levelName)}.bind(this));if(e)e(t)}.bind(this),async:false});return i}.bind(this));this.define("setWorkId",function(){if(this.workContext.getWork().activityName=="发起"){this.form.get("provinceWorkId").setData(this.workContext.getWork().id);this.form.get("currentWorkId").setData(this.workContext.getWork().id)}if(this.workContext.getWork().activityName=="市级接收单元负责人处理"){this.form.get("cityWorkId").setData(this.workContext.getWork().id);this.form.get("currentWorkId").setData(this.workContext.getWork().id)}if(this.workContext.getWork().activityName=="县级接收单元负责人处理"){this.form.get("countyWorkId").setData(this.workContext.getWork().id);this.form.get("currentWorkId").setData(this.workContext.getWork().id)}if(this.workContext.getWork().activityName=="网格接收单元负责人处理"){this.form.get("branchWorkId").setData(this.workContext.getWork().id);this.form.get("currentWorkId").setData(this.workContext.getWork().id)}});this.define("getUnitLevel",function(t,e){var i=this.workContext.getWork().creatorIdentityDn;var n;MWF.Actions.get("x_organization_assemble_express")[e?"getUnitWithIdentityAndLevel":"getUnitWithIdentityAndLevelValue"]({identity:i,level:t},function(t){n=t.data.unit}.bind(this),null,false);return n}.bind(this));this.define("openMinder",function(t){debugger;var e={pageId:"71acdde6-97cc-4c6d-abe2-817ea5afad4f",portalId:"b66420c3-dee9-4b4c-9d52-050fd0921864",workId:t,appId:"portal_"+t};if(layout.desktop.openApplication){layout.desktop.openApplication(null,"portal.Portal",e)}else{window.open("/x_desktop/app.html?app=portal.Portal&option="+JSON.stringify(e))}});this.define("openUploadForm",function(){if(!this.data.subject){this.form.app.notice("请填写任务名称并保存","error");return}var t=this.form.uploadExcelDialog=new UploadExcelDialog({app:this.form.app},{workName:this.data.subject,workId:this.data.provinceWorkId||this.data.currentWorkId,jobId:this.workContext.getWork().job,categoryId:"288a0f05-78dd-4650-af79-236e33832a7e"},{});t.contextForm=this.form;t.context=this;t.edit()});var ProgressBar=new Class({initialize:function(t){this.container=t},load:function(){this.getCss();this.loadSteps();this.loadProgressBar()},setProgress:function(t,e,i){var n=Math.floor(t/e*100);this.progressFront.setStyles({width:n+"%"});this.textNode.set("text",i+"，共"+e+"条，已处理"+t+"条，进度"+n+"%")},loadProgressBar:function(){this.progressNode=new Element("div",{styles:this.css.progressNode}).inject(this.container);this.progressBack=new Element("div.progressBack",{styles:this.css.progressBack}).inject(this.progressNode);this.progressBack.setStyle("width","100%");this.progressFront=new Element("div.progressFront",{styles:this.css.progressFront,text:" "}).inject(this.progressBack);this.progressFront.setStyle("width","0px");this.textNode=new Element("div",{styles:this.css.textNode}).inject(this.container)},getCss:function(){this.css={loadingNode:{},textNode:{"margin-top":"10px","font-size":"12px","margin-left":"10px"},progressNode:{margin:"10px 0px",overflow:"hidden"},progressBack:{float:"left","border-radius":"10px","background-color":"#f4f4f4",height:"16px"},progressFront:{height:"16px","background-color":"#4a9adb"}}}});this.define("loadStatTable",function(t,e,i,n){t.empty();if(!this.form.statJson){this.form.statJson=new StatJson(this)}if(!i&&this.statTableOptions){i=this.statTableOptions.unitLevel}if(!n&&this.statTableOptions){n=this.statTableOptions.unitName}this.form.statJson.loadTable(t,e,i,n)});var StatJson=new Class({initialize:function(t){this.context=t;if(this.context.data.statJson){this.json=JSON.parse(this.context.data.statJson)}else{this.json={total:{publishedCount:0,errorCount:0},batch:{}}}},submit:function(){this.deleteEmptyUnit();for(var t in this.json.batch){this.deleteEmptyUnit(t)}this.context.data.statJson=JSON.stringify(this.json)},addBatch:function(t,e){if(!this.json.batch[t]){this.json.batch[t]={publishedCount:0,errorCount:0}}if(e)this.currentBatch=this.json.batch[t]},deleteBatch:function(t){var e=this.json;var i=e.batch[t];if(i){if(i.publishedCount){e.total.publishedCount=e.total.publishedCount-i.publishedCount}if(i.errorCount){e.total.errorCount=e.total.errorCount-i.errorCount}this.reduceByBatchData(i);delete this.json.batch[t]}},reduceByBatchData:function(t){var e=this.json.total;for(var i in t){if(i!="publishedCount"&&i!="errorCount"){var n=e[i];var r=t[i];if(t.publishedCount)n.publishedCount=n.publishedCount-r.publishedCount;if(t.errorCount)n.errorCount=n.errorCount-r.errorCount;for(var o in r){if(o!="publishedCount"&&o!="errorCount"){var s=n[o];var a=r[o];if(a.publishedCount)s.publishedCount=s.publishedCount-a.publishedCount;if(a.errorCount)s.errorCount=s.errorCount-a.errorCount;for(var l in a){if(l!="publishedCount"&&l!="errorCount"){var u=s[l];var d=a[l];if(d.publishedCount)u.publishedCount=u.publishedCount-d.publishedCount;if(d.errorCount)u.errorCount=u.errorCount-d.errorCount}}}}}}},addData:function(t){var e=t;var i=this.json.total;var n=this.currentBatch;if(e.docStatus=="published"){i.publishedCount++;n.publishedCount++;this.addCount(i,e);this.addCount(n,e)}else if(e.docStatus=="error"){i.errorCount++;n.errorCount++}},addCount:function(t,e){if(e.city){var i=t[e.city];if(!i){i=t[e.city]={publishedCount:0}}i.publishedCount++;if(e.county){var n=i[e.county];if(!n){n=i[e.county]={publishedCount:0}}n.publishedCount++;if(e.branch){var r=n[e.branch];if(!r){r=n[e.branch]={publishedCount:0}}r.publishedCount++}}}else{var o="未设置组织";var i=t[o];if(!i){i=t[o]={publishedCount:0}}i.publishedCount++}},reduceCount:function(t,e){if(e.city){var i=t[e.city];if(!i){i=t[e.city]={publishedCount:0}}i.publishedCount--;if(e.county){var n=i[e.county];if(!n){n=i[e.county]={publishedCount:0}}n.publishedCount--;if(e.branch){var r=n[e.branch];if(!r){r=n[e.branch]={publishedCount:0}}r.publishedCount--}}}else{var o="未设置组织";var i=t[o];if(!i){i=t[o]={publishedCount:0}}i.publishedCount--}},getCity:function(){var t=this.json.total;var e=[];for(var i in t){if(i!="publishedCount"&&i!="errorCount"&&i!="未设置组织"){if(t[i].publishedCount>0){e.push(i)}}}return e},getCounty:function(t){var e=this.json.total;var i=[];if(e[t]){var n=e[t];for(var r in n){if(r!="publishedCount"&&r!="errorCount"&&r!="未设置组织"){if(n[r].publishedCount>0){i.push(r)}}}}return i},getBranch:function(t,e){var i=this.json.total;var n=[];if(i[t]){var r=i[t];if(r[e]){var o=r[e];for(var s in o){if(s!="publishedCount"&&s!="errorCount"&&s!="未设置组织"){if(o[s].publishedCount>0){n.push(s)}}}}}return n},getAllCounty:function(){debugger;var t=this.json.total;var e=[];for(var i in t){if(i!="publishedCount"&&i!="errorCount"&&i!="未设置组织"){for(var n in t[i]){if(n!="publishedCount"&&n!="errorCount"&&n!="未设置组织"){if(t[i][n].publishedCount>0){e.push(n)}}}}}return e},getAllBranch:function(){var t=this.json.total;var e=[];for(var i in t){if(i!="publishedCount"&&i!="errorCount"&&i!="未设置组织"){for(var n in t[i]){if(n!="publishedCount"&&n!="errorCount"&&n!="未设置组织"){for(var r in t[i][n]){if(r!="publishedCount"&&r!="errorCount"&&r!="未设置组织"){if(t[i][n][r].publishedCount>0){e.push(r)}}}}}}}return e},getUnitCount:function(t,e){var i;if(e&&this.json.batch[e]){i=this.json.batch[e]}else{i=this.json.total}if(!t)return i.publishedCount;for(var n in i){var r=i[n];if(n==t)return r.publishedCount;for(var o in r){var s=r[o];if(o==t)return s.publishedCount;for(var a in s){var l=s[a];if(a==t)return l.publishedCount}}}return 0},changeData:function(t,e,i){debugger;var n;if(i&&this.json.batch[i]){n=this.json.batch[i]}var r=this.json.total;if(e.docStatus=="error"){r.errorCount--;if(n)n.errorCount--}if(e.docStatus=="published"){r.publishedCount--;this.reduceCount(r,e);if(n){n.publishedCount--;this.reduceCount(n,e)}}if(t.docStatus=="error"){r.errorCount++;if(n)n.errorCount++}if(t.docStatus=="published"){r.publishedCount++;this.addCount(r,t);if(n){n.publishedCount++;this.addCount(n,t)}}},getPublishedCount:function(t){if(!t){return this.json.total.publishedCount}else{if(this.json.batch[t]){var e=this.json.batch[t];return e.publishedCount}}},getErrorCount:function(t){if(!t){return this.json.total.errorCount}else{if(this.json.batch[t]){var e=this.json.batch[t];return e.errorCount}}},deleteEmptyUnit:function(t){if(t){var e=this.json.batch[t]}else{var e=this.json.total}for(var i in e){if(i!="publishedCount"&&i!="errorCount"){var n=e[i];if(!n.publishedCount&&!n.errorCount){delete e[i]}else{for(var r in n){if(r!="publishedCount"&&r!="errorCount"){var o=n[r];if(!o.publishedCount&&!o.errorCount){delete e[i][r]}else{for(var s in o){if(s!="publishedCount"&&s!="errorCount"){var a=o[s];if(!a.publishedCount&&!a.errorCount){delete e[i][r][s]}}}}}}}}}},getNoUnitJson:function(t){var e=Object.clone(t);for(var i in e){if(i!="publishedCount"&&i!="errorCount"){var n=e[i];var r=n.publishedCount;var o=0;for(var s in n){if(s!="publishedCount"&&s!="errorCount"){var a=n[s];o=o+a.publishedCount;var l=0;for(var u in a){if(u!="publishedCount"&&u!="errorCount"){var d=a[u];l=l+d.publishedCount}}if(a.publishedCount>l){a["未设置"]={publishedCount:a.publishedCount-l}}}}if(n.publishedCount>o){n["未设置"]={publishedCount:n.publishedCount-o}}}}return e},loadTable:function(t,e,i,n){if(!i){this._loadTable(t,e)}else{this._loadTableByUnit(t,e,i,n)}},_loadTableByUnit:function(t,e,i,n){if(e){var r=this.json.batch[e]}else{var r=this.json.total}var o=this.getNoUnitJson(r);debugger;var s=this.table=new Element("table",{width:"90%",border:"0",cellpadding:"5",cellspacing:"0",styles:{"border-top":"1px solid #ccc","border-left":"1px solid #ccc",margin:"20px auto 10px auto","font-size":"14px"}}).inject(t);if(e){var a=e.split("_")[1];var l=a.substring(0,4);var u=a.substring(4,6);var d=a.substring(6,8);var h=a.substring(8,10);var c=a.substring(10,12);var f=a.substring(12,14);var p=l+"-"+u+"-"+d+" "+h+":"+c+":"+f+"批次数据统计"}else{var p="数据统计"}if(i=="city")this._loadTableByCity(p,o,s,n);if(i=="county")this._loadTableByCounty(p,o,s,n);if(i=="branch")this._loadTableByBranch(p,o,s,n)},_loadTableByCity:function(t,e,i,n){var r={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center"};var o={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center","font-size":"16px","font-weight":"bold"};var s=new Element("tr").inject(i);new Element("td",{styles:o,text:t,colspan:3}).inject(s);var s=new Element("tr").inject(i);new Element("th",{styles:r,text:"市分"}).inject(s);new Element("th",{styles:r,text:"县分"}).inject(s);new Element("th",{styles:r,text:"网格"}).inject(s);debugger;for(var a in e){if(a!=n)continue;if(a!="publishedCount"&&a!="errorCount"){var l=new Element("tr").inject(i);var u=e[a];var d=a=="未设置组织"?"未设置":a.split("@")[0];var h=new Element("td",{styles:r,text:d+"("+u.publishedCount+")"}).inject(l);var c=1;var f=0;var p=null;var m=null;var v=null;for(var b in u){if(b!="publishedCount"&&b!="errorCount"){if(f!=0){c++;p=new Element("tr").inject(i)}f++;var g=1;var C=u[b];m=new Element("td",{styles:r,text:b.split("@")[0]+"("+C.publishedCount+")"}).inject(p||l);var x=0;var w=null;for(var y in C){if(y!="publishedCount"&&y!="errorCount"){if(x!=0){w=new Element("tr").inject(i);c++;g++}x++;var k=C[y];v=new Element("td",{styles:r,text:y.split("@")[0]+"("+k.publishedCount+")"}).inject(w||p||l)}}if(x==0){v=new Element("td",{styles:r,text:""}).inject(w||p||l)}m.set("rowspan",g)}}if(f==0){m=new Element("td",{styles:r,text:""}).inject(p||l)}if(!v){new Element("td",{styles:r,text:""}).inject(p||l)}h.set("rowspan",c)}}},_loadTableByCounty:function(t,e,i,n){var r={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center"};var o={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center","font-size":"16px","font-weight":"bold"};var s=new Element("tr").inject(i);new Element("td",{styles:o,text:t,colspan:2}).inject(s);var s=new Element("tr").inject(i);new Element("th",{styles:r,text:"县分"}).inject(s);new Element("th",{styles:r,text:"网格"}).inject(s);debugger;for(var a in e){if(a!="publishedCount"&&a!="errorCount"){var l=e[a];var u=0;var d=null;var h=null;var c=null;for(var f in l){if(n!=f)continue;if(f!="publishedCount"&&f!="errorCount"){d=new Element("tr").inject(i);u++;var p=1;var m=l[f];h=new Element("td",{styles:r,text:f.split("@")[0]+"("+m.publishedCount+")"}).inject(d);var v=0;var b=null;for(var g in m){if(g!="publishedCount"&&g!="errorCount"){if(v!=0){b=new Element("tr").inject(i);p++}v++;var C=m[g];c=new Element("td",{styles:r,text:g.split("@")[0]+"("+C.publishedCount+")"}).inject(b||d)}}if(v==0){c=new Element("td",{styles:r,text:""}).inject(b||d)}h.set("rowspan",p)}}if(!c&&d){new Element("td",{styles:r,text:""}).inject(d)}}}},_loadTableByBranch:function(t,e,i,n){var r={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center"};var o={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center","font-size":"16px","font-weight":"bold"};var s=new Element("tr").inject(i);new Element("td",{styles:o,text:t}).inject(s);for(var a in e){if(a!="publishedCount"&&a!="errorCount"){var l=e[a];var u=null;for(var d in l){if(d!="publishedCount"&&d!="errorCount"){var h=l[d];for(var c in h){if(c!=n)continue;if(c!="publishedCount"&&c!="errorCount"){var f=new Element("tr").inject(i);var p=h[c];u=new Element("td",{styles:r,text:c.split("@")[0]+"("+p.publishedCount+")"}).inject(f)}}}}}}},_loadTable:function(t,e){if(e){var i=this.json.batch[e]}else{var i=this.json.total}var n=this.getNoUnitJson(i);debugger;var r={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center"};var o={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center","font-size":"16px","font-weight":"bold"};var s=this.table=new Element("table",{width:"90%",border:"0",cellpadding:"5",cellspacing:"0",styles:{"border-top":"1px solid #ccc","border-left":"1px solid #ccc",margin:"20px auto 10px auto","font-size":"14px"}}).inject(t);var a=new Element("tr").inject(s);if(e){var l=e.split("_")[1];var u=l.substring(0,4);var d=l.substring(4,6);var h=l.substring(6,8);var c=l.substring(8,10);var f=l.substring(10,12);var p=l.substring(12,14);var m=u+"-"+d+"-"+h+" "+c+":"+f+":"+p+"批次数据统计"}else{var m="数据统计"}new Element("td",{styles:o,text:m,colspan:3}).inject(a);var a=new Element("tr").inject(s);new Element("td",{styles:r,text:"校验未通过（条）"}).inject(a);new Element("td",{styles:r,colspan:2,text:n.errorCount||""}).inject(a);var a=new Element("tr").inject(s);new Element("td",{styles:r,text:"校验通过（条）"}).inject(a);new Element("td",{styles:r,colspan:2,text:n.publishedCount||""}).inject(a);var a=new Element("tr").inject(s);new Element("th",{styles:r,text:"市分"}).inject(a);new Element("th",{styles:r,text:"县分"}).inject(a);new Element("th",{styles:r,text:"网格"}).inject(a);debugger;for(var v in n){if(v!="publishedCount"&&v!="errorCount"){var b=new Element("tr").inject(s);var g=n[v];var C=v=="未设置组织"?"未设置":v.split("@")[0];var x=new Element("td",{styles:r,text:C+"("+g.publishedCount+")"}).inject(b);var w=1;var y=0;var k=null;var j=null;var E=null;for(var T in g){if(T!="publishedCount"&&T!="errorCount"){if(y!=0){w++;k=new Element("tr").inject(s)}y++;var N=1;var S=g[T];j=new Element("td",{styles:r,text:T.split("@")[0]+"("+S.publishedCount+")"}).inject(k||b);var I=0;var _=null;for(var U in S){if(U!="publishedCount"&&U!="errorCount"){if(I!=0){_=new Element("tr").inject(s);w++;N++}I++;var B=S[U];E=new Element("td",{styles:r,text:U.split("@")[0]+"("+B.publishedCount+")"}).inject(_||k||b)}}if(I==0){E=new Element("td",{styles:r,text:""}).inject(_||k||b)}j.set("rowspan",N)}}if(y==0){j=new Element("td",{styles:r,text:""}).inject(k||b)}if(!E){new Element("td",{styles:r,text:""}).inject(k||b)}x.set("rowspan",w)}}}});