MWF.xApplication.cms.FormDesigner.Module=MWF.xApplication.cms.FormDesigner.Module||{};MWF.xDesktop.requireApp("process.FormDesigner","Module.Subform",null,false);MWF.xApplication.cms.FormDesigner.Module.Subform=MWF.CMSFCSubform=new Class({Extends:MWF.FCSubform,Implements:[MWF.CMSFCMI],openSubform:function(e){if(this.json.subformSelected&&this.json.subformSelected!=="none"&&this.json.subformType!=="script"){layout.desktop.openApplication(e,"cms.FormDesigner",{id:this.json.subformSelected,appId:"FormDesigner"+this.json.subformSelected})}},refreshSubform:function(){if(this.json.subformSelected&&this.json.subformSelected!=="none"&&this.json.subformType!=="script"){MWF.Actions.get("x_cms_assemble_control").getForm(this.json.subformSelected,function(e){if(this.subformData.updateTime!==e.data.updateTime){var t=null;if(this.property){t=$(this.property.data.pid+"selectSubform").getElement("select")}this.clearSubformList(this.json.subformSelected);this.reloadSubform(e.data,t,"")}}.bind(this))}},redoSelectedSubform:function(e,t,s){if(this.json.subformSelected==="none")this.json.subformSelected="";if(this.json.subformSelected&&this.json.subformSelected!=="none"){if(this.form.subformList&&this.form.subformList[this.json.subformSelected]){var o=this.node.getPosition(document.bosy);this.form.designer.alert("error",{event:{x:o.x+150,y:o.y+80}},this.form.designer.lp.subformConflictTitle,this.form.designer.lp.subformConflictInfor,400,120);this.json.subformSelected=s;if(t){for(var i=0;i<t.options.length;i++){if(t.options[i].value===s){t.options[i].set("selected",true);break}}}this.node.empty();this.loadIcon()}else{MWF.Actions.get("x_cms_assemble_control").getForm(this.json.subformSelected,function(e){this.reloadSubform(e.data,t,s)}.bind(this))}}else{this.subformData=null;this.clearSubformList(s);this.node.empty();this.loadIcon()}},regetSubformData:function(){var t=false;if(this.json.subformSelected&&this.json.subformSelected!=="none"&&this.json.subformType!=="script"){MWF.Actions.get("x_cms_assemble_control").getForm(this.json.subformSelected,function(e){if(!this.subformData||this.subformData.updateTime!==e.data.updateTime){this.getSubformData(e.data);t=true}}.bind(this),null,false)}return t},checkSubform:function(e,t){var s=this.getConflictFields();if(s.length){var o=this.form.designer.lp.subformNameConflictInfor;o=o.replace("{name}",s.join(", "));this.form.designer.notice(o,"error",this.node);return false}return true},loadSubform:function(e){this.subformData.json.style=this.form.json.style;this.subformData.json.properties=this.form.json.properties;this.subformData.json.jsheader={code:"",html:""};this.subformData.json.events={};this.subformData.json.formStyleType=this.form.json.formStyleType;this.subformModule=new MWF.CMSFCSubform.Form(this.form,this.node);this.subformModule.load(this.subformData)}});MWF.xApplication.cms.FormDesigner.Module.Subform.Form=new Class({Extends:MWF.CMSFCForm,initialize:function(e,t,s){this.parentform=e;this.css=this.parentform.css;this.container=t;this.form=this;this.isSubform=true;this.moduleType="subform";this.moduleList=[];this.moduleNodeList=[];this.moduleContainerNodeList=[];this.moduleElementNodeList=[];this.moduleComponentNodeList=[];this.dataTemplate={};this.designer=this.parentform.designer;this.selectedModules=[]},load:function(e){this.data=e;this.json=e.json;this.html=e.html;this.json.mode=this.options.mode;this.container.set("html",this.html);this.loadDomModules();if(this.options.mode==="Mobile"){if(oldStyleValue)this._setEditStyle("formStyleType",null,oldStyleValue)}},loadDomModules:function(){this.node=this.container.getFirst();this.node.set("id",this.json.id);this.node.setStyles(this.options.mode==="Mobile"?this.css.formMobileNode:this.css.formNode);this.node.store("module",this);this.loadDomTree()},loadDomTree:function(){this.createFormTreeNode();this.parseModules(this,this.node)},createFormTreeNode:function(){this.treeNode={insertChild:function(){return this},appendChild:function(){return this},selectNode:function(){},node:null,parentNode:{}};this.treeNode.module=this}});