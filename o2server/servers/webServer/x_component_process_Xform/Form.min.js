MWF.require("MWF.widget.Common",null,false);MWF.require("MWF.widget.Identity",null,false);MWF.xApplication.process=MWF.xApplication.process||{};MWF.xApplication.process.Xform=MWF.xApplication.process.Xform||{};MWF.xDesktop.requireApp("process.Xform","Package",null,false);MWF.xApplication.process.Xform.Form=MWF.APPForm=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",readonly:false,cssPath:"",macro:"FormContext",parameters:null,moduleEvents:["queryLoad","beforeLoad","postLoad","afterLoad","beforeSave","afterSave","beforeClose","beforeProcess","beforeProcessWork","afterProcess","beforeReset","afterReset","beforeRetract","afterRetract","beforeReroute","afterReroute","beforeDelete","beforeModulesLoad","resize","afterModulesLoad"]},initialize:function(t,e,i){this.setOptions(i);this.container=$(t);this.container.setStyle("-webkit-user-select","text");this.data=e;this.json=e.json;this.html=e.html;this.path="/x_component_process_Xform/$Form/";this.cssPath=this.options.cssPath||"/x_component_process_Xform/$Form/"+this.options.style+"/css.wcss";this._loadCss();this.modules=[];this.all={};this.forms={}},load:function(){if(this.app){if(this.app.formNode)this.app.formNode.setStyles(this.json.styles);if(this.app.addEvent)this.app.addEvent("resize",function(){this.fireEvent("resize")}.bind(this))}if(!this.businessData.control.allowSave)this.setOptions({readonly:true});this.loadMacro(function(){this.container.set("html",this.html);this.node=this.container.getFirst();this._loadEvents();if(this.fireEvent("queryLoad")){if(this.app)if(this.app.fireEvent)this.app.fireEvent("queryLoad");MWF.xDesktop.requireApp("process.Xform","lp."+MWF.language,null,false);this._loadBusinessData();this.fireEvent("beforeLoad");if(this.app)if(this.app.fireEvent)this.app.fireEvent("beforeLoad");this.loadContent()}}.bind(this))},loadMacro:function(t){MWF.require("MWF.xScript.Macro",function(){this.Macro=new MWF.Macro[this.options.macro||"FormContext"](this);if(t)t()}.bind(this))},loadContent:function(){this._loadHtml();this._loadForm();this.fireEvent("beforeModulesLoad");if(this.app&&this.app.fireEvent)this.app.fireEvent("beforeModulesLoad");this._loadModules(this.node);this.fireEvent("afterModulesLoad");this.fireEvent("postLoad");this.fireEvent("afterLoad");if(this.app&&this.app.fireEvent){this.app.fireEvent("afterModulesLoad");this.app.fireEvent("postLoad");this.app.fireEvent("afterLoad")}},_loadBusinessData:function(){if(!this.businessData){this.businessData={}}},_loadHtml:function(){this.node.addEvent("selectstart",function(t){var e="text";if(t.target.getStyle("-webkit-user-select")){e=t.target.getStyle("-webkit-user-select").toString().toLowerCase()}if(e!=="text"&&e!=="auto")t.preventDefault()})},_loadForm:function(){this._loadStyles();this._loadCssLinks();this._loadScriptSrc();this._loadJsheader()},_loadStyles:function(){this.node.setStyles(this.json.styles)},_loadCssLinks:function(){var t=this.json.cssLinks;t.each(function(t){new Element("link",{rel:"stylesheet",type:"text/css",href:t}).inject($(document.head))})},_loadScriptSrc:function(){var t=this.json.scriptSrc;t.each(function(t){new Element("script",{src:t}).inject($(document.head))})},_loadJsheader:function(){var t=this.json.jsheader.code;if(t)Browser.exec(t)},_loadEvents:function(){Object.each(this.json.events,function(e,t){if(e.code){if(this.options.moduleEvents.indexOf(t)!==-1){this.addEvent(t,function(t){return this.Macro.fire(e.code,this,t)}.bind(this))}else{if(t==="load"){this.addEvent("postLoad",function(){return this.Macro.fire(e.code,this)}.bind(this))}else if(t==="submit"){this.addEvent("beforeProcess",function(){return this.Macro.fire(e.code,this)}.bind(this))}else{this.node.addEvent(t,function(t){return this.Macro.fire(e.code,this,t)}.bind(this))}}}}.bind(this))},_getDomjson:function(t){var e=t.get("MWFtype")||t.get("mwftype");switch(e){case"form":return this.json;case"":return null;default:var i=t.get("id");if(!i)i=t.get("MWFId");if(i){return this.json.moduleList[i]}else{return null}}},_getModuleNodes:function(t){var e=[];var i=t.getFirst();while(i){var s=i.get("MWFtype")||i.get("mwftype");if(s){var o=s;if(o.indexOf("$")===-1){e.push(i)}if(s!=="datagrid"&&s!=="subSource"){e=e.concat(this._getModuleNodes(i))}}else{e=e.concat(this._getModuleNodes(i))}i=i.getNext()}return e},_loadModules:function(t){debugger;var e=this._getModuleNodes(t);debugger;e.each(function(t){var e=this._getDomjson(t);var i=this._loadModule(e,t);this.modules.push(i)}.bind(this))},_loadModule:function(t,e,i){if(!MWF["APP"+t.type]){MWF.xDesktop.requireApp("process.Xform",t.type,null,false)}var s=new MWF["APP"+t.type](e,t,this);if(i)i.apply(s);if(!this.all[t.id])this.all[t.id]=s;if(s.field){if(!this.forms[t.id])this.forms[t.id]=s}s.readonly=this.options.readonly;s.load();return s},saveOpinion:function(t){var i=t._getBusinessSectionDataByPerson();MWF.UD.getDataJson("userOpinion",function(t){if(!t)t=[];var e=t.indexOf(i);if(e==-1){if(t.length>=50)t.shift()}else{t.splice(e,1)}t.push(i);MWF.UD.putData("userOpinion",t)}.bind(this),false)},getData:function(s){var o=Object.clone(this.businessData.data);Object.each(this.forms,function(t,e){if(t.json.type==="Opinion"){if(s){this.saveOpinion(t);delete o[e]}else{var i=t.getData();o[e]=this.getSectionDataByPerson(i,o[e])}}else{if(t.json.section==="yes"){o[e]=this.getSectionData(t,o[e])}else{o[e]=t.getData()}}}.bind(this));this.businessData.data=o;this.Macro.environment.setData(this.businessData.data);return o},getSectionData:function(t,e){var i=t.getData();switch(t.json.sectionBy){case"person":return this.getSectionDataByPerson(i,e);break;case"unit":return this.getSectionDataByUnit(i,e);break;case"activity":return this.getSectionDataByPActivity(i,e);break;case"script":return this.getSectionDataByScript(t.json.sectionByScript.code,i,e);break;default:return i}},getSectionDataByPerson:function(t,e){var i=layout.desktop.session.user.id;if(!e||typeOf(e)!=="object")e={};e[i]=t;return e},getSectionDataByUnit:function(t,e){var i=this.businessData.task?this.businessData.task.unit:"";if(!e||typeOf(e)!=="object")e={};if(i)e[i]=t;return e},getSectionDataByPActivity:function(t,e){var i=this.businessData.work?this.businessData.work.activity:"";if(!e||typeOf(e)!=="object")e={};if(i)e[i]=t;return e},getSectionDataByScript:function(t,e,i){var s=this.form.Macro.exec(t,this);if(!i||typeOf(i)!=="object")i={};if(s)i[s]=e;return i},saveWork:function(e){if(this.businessData.control["allowSave"]){this.fireEvent("beforeSave");if(this.app&&this.app.fireEvent)this.app.fireEvent("beforeSave");this.saveFormData(function(t){this.app.notice(MWF.xApplication.process.Xform.LP.dataSaved,"success");if(e)e();this.fireEvent("afterSave");if(this.app&&this.app.fireEvent)this.app.fireEvent("afterSave")}.bind(this))}else{MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied")}},saveFormData:function(t,e,i,s,o){if(this.officeList){this.officeList.each(function(t){t.save(i)})}this.workAction.saveData(t,e,this.businessData.work.id,s||this.getData(o))},closeWork:function(){this.fireEvent("beforeClose");if(this.app&&this.app.fireEvent){this.app.fireEvent("beforeClose")}this.app.close()},addMessage:function(t){var i="";if(t.length){t.each(function(t){var e=[];t.taskList.each(function(t){e.push(MWF.name.cn(t.person)+"("+MWF.name.cn(t.unit)+")")}.bind(this));i+="<div><b>"+MWF.xApplication.process.Xform.LP.nextActivity+'<font style="color: #ea621f">'+t.fromActivityName+"</font>, "+MWF.xApplication.process.Xform.LP.nextUser+'<font style="color: #ea621f">'+e.join(", ")+"</font></b></div>"}.bind(this))}else{i+=MWF.xApplication.process.Xform.LP.workCompleted}var e={subject:MWF.xApplication.process.Xform.LP.taskProcessed,content:"<div>"+MWF.xApplication.process.Xform.LP.taskProcessedMessage+"“"+this.businessData.work.title+"”</div>"+i};layout.desktop.message.addTooltip(e);return layout.desktop.message.addMessage(e)},formValidation:function(i,s){if(this.options.readonly)return true;this.Macro.environment.form.currentRouteName=i;this.Macro.environment.form.opinion=s;var o=true;Object.each(this.forms,function(t,e){t.validationMode();if(!t.validation(i,s))o=false}.bind(this));return o},validation:function(t,e,i){this.Macro.environment.form.currentRouteName=t;this.Macro.environment.form.opinion=e;var s=this.validationRoute(i);var o=this.validationOpinion(i);return s&&o},validationRoute:function(t){if(!this.json.validationRoute)return true;if(!this.json.validationRoute.code)return true;var e=this.Macro.exec(this.json.validationRoute.code,this);if(!e)e=MWF.xApplication.process.Xform.LP.notValidation;if(e.toString()!="true"){this.notValidationRouteMode(e,t);return false}return true},validationOpinion:function(t){if(!this.json.validationOpinion)return true;if(!this.json.validationOpinion.code)return true;var e=this.Macro.exec(this.json.validationOpinion.code,this);if(!e)e=MWF.xApplication.process.Xform.LP.notValidation;if(e.toString()!="true"){this.notValidationOpinionMode(e,t);return false}return true},formCustomValidation:function(){if(!this.json.validationFormCustom)return true;if(!this.json.validationFormCustom.code)return true;var t=this.Macro.exec(this.json.validationFormCustom.code,this);if(!t)t=MWF.xApplication.process.Xform.LP.notValidation;if(t.toString()!="true"){this.notValidationOpinionMode(t);return false}return true},notValidationRouteMode:function(t,e){e.routeSelectorArea.setStyle("background-color","#ffe9e9");new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:false,target:e.routeSelectorArea,delayClose:6e3,content:t})},notValidationOpinionMode:function(t,e){if(e)e.inputTextarea.setStyle("background-color","#ffe9e9");new mBox.Notice({type:"error",position:e?{x:"center",y:"top"}:{x:"right",y:"top"},move:false,target:e?e.inputTextarea:this.app.content,delayClose:6e3,content:t})},submitWork:function(e,s,o,n,t,i){debugger;if(!this.businessData.control["allowProcessing"]){MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied");this.app.content.unmask();t.node.unmask();return false}if(!this.formValidation(e,s)){this.app.content.unmask();if(n)n();return false}if(!this.validation(e,s,t)){t.node.unmask();return false}if(!s){var a=this.businessData.task.routeNameList.indexOf(e);if(this.businessData.task.routeOpinionList[a]){s=this.businessData.task.routeOpinionList[a]}else{s=e}}this.fireEvent("beforeProcess");if(this.app&&this.app.fireEvent)this.app.fireEvent("beforeProcess");MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4});this.mask.loadNode(this.app.content);this.fireEvent("beforeSave");if(this.app&&this.app.fireEvent)this.app.fireEvent("beforeSave");this.saveFormData(function(t){this.businessData.task.routeName=e;this.businessData.task.opinion=s;debugger;var i=[];if(o&&o.length){o.each(function(t){var e=new FormData;e.append("file",t);e.append("site","$mediaOpinion");this.workAction.uploadAttachment(this.businessData.work.id,e,t,function(t){i.push(t.data.id)}.bind(this),null,false)}.bind(this))}if(i.length)this.businessData.task.mediaOpinion=i.join(",");this.fireEvent("afterSave");if(this.app&&this.app.fireEvent)this.app.fireEvent("afterSave");this.workAction.processTask(function(t){if(n)n();this.fireEvent("afterProcess");if(this.app&&this.app.fireEvent)this.app.fireEvent("afterProcess");this.addMessage(t.data);if(this.app.taskObject)this.app.taskObject.destroy();if(layout.mobile){var e=new URI(window.location.href);var i=e.getData("redirectlink");if(i){window.location=decodeURIComponent(i)}else{window.location="appMobile.html?app=process.TaskCenter"}}else{this.app.close()}}.bind(this),null,this.businessData.task.id,this.businessData.task)}.bind(this),null,true,i,true)}.bind(this))},processWork:function(){if(this.app.inBrowser){this.app.content.setStyle("height",document.body.getSize().y)}this.fireEvent("beforeProcessWork");if(this.app&&this.app.fireEvent)this.app.fireEvent("beforeProcessWork");var t=this.app.content.getPosition(this.app.content.getOffsetParent());this.app.content.mask({destroyOnHide:true,style:this.app.css.maskNode,useIframeShim:true,iframeShimOptions:{browsers:true},onShow:function(){this.shim.shim.setStyles({opacity:0,top:""+t.y+"px",left:""+t.x+"px"})}});if(!this.formCustomValidation("","")){this.app.content.unmask();return false}if(!this.formValidation("","")){this.app.content.unmask();return false}var e=this.createProcessNode();this.setProcessNode(e);this.showProcessNode(e)},createProcessNode:function(){if(layout.mobile){var t=this.app.content.getSize();this.app.css.processNode_from.width=t.x+"px";this.app.css.processNode.width=t.x+"px"}var e=new Element("div",{styles:this.app.css.processNode_from}).inject(this.app.content);e.position({relativeTo:this.app.content,position:"topcenter",edge:"topcenter"});return e},getOpinion:function(){var i="";var s=[];Object.each(this.forms,function(t,e){if(t.json.type==="Opinion")if(this.businessData.data[e])i+=" "+t._getBusinessSectionDataByPerson();if(t.handwritingFile)if(t.handwritingFile[layout.session.user.distinguishedName])s.push(t.handwritingFile[layout.session.user.distinguishedName]);if(t.soundFile)if(t.soundFile[layout.session.user.distinguishedName])s.push(t.soundFile[layout.session.user.distinguishedName]);if(t.videoFile)if(t.videoFile[layout.session.user.distinguishedName])s.push(t.videoFile[layout.session.user.distinguishedName])}.bind(this));return{opinion:i.trim(),medias:s}},setProcessNode:function(o){var n=this;debugger;MWF.xDesktop.requireApp("process.Work","Processor",function(){var t=this.getOpinion();var s=t.medias;new MWF.xApplication.process.Work.Processor(o,this.businessData.task,{style:layout.mobile?"mobile":"default",opinion:t.opinion,onCancel:function(){o.destroy();n.app.content.unmask();delete this},onSubmit:function(t,e,i){if(!i||!i.length)i=s;n.submitWork(t,e,i,function(){this.destroy();o.destroy();delete this}.bind(this),this)}})}.bind(this))},showProcessNode:function(t){var e=this.app.content.getSize();var i=t.getSize();var s=e.y/2-i.y/2-20;var o=e.x/2-i.x/2;if(s<0)s=0;this.app.css.processNode.top=""+s+"px";this.app.css.processNode.left=""+o+"px";var n=new Fx.Morph(t,{duration:300,transition:Fx.Transitions.Expo.easeOut});n.start(this.app.css.processNode)},confirm:function(n,a,r,c,p,l,f,d,t,h,u){MWF.require("MWF.xDesktop.Dialog",function(){var t=this.container.getSize();var e=0;var i=0;if(typeOf(a)==="element"){var s=a.getPosition(this.app.content);e=s.x;i=s.y}else{if(Browser.name=="firefox"){e=parseFloat(a.event.clientX||a.event.x);i=parseFloat(a.event.clientY||a.event.y)}else{e=parseFloat(a.event.x);i=parseFloat(a.event.y)}if(a.target){var s=a.target.getPosition(this.app.content);e=s.x;i=s.y}}if(e+parseFloat(p)>t.x){e=e-parseFloat(p)}if(e<0)e=10;if(i+parseFloat(l)>t.y){i=i-parseFloat(l)}if(i<0)i=10;if(e<0)e=20;var o=new MWF.xDesktop.Dialog({title:r,style:u||"o2",top:i,left:e-20,fromTop:a.event.y,fromLeft:Browser.name==="firefox"?a.event.clientX-20:a.event.x-20,width:p,height:l,text:c,container:this.app.content,maskNode:h||this.app.content,buttonList:[{text:MWF.LP.process.button.ok,action:f},{text:MWF.LP.process.button.cancel,action:d}]});switch(n.toLowerCase()){case"success":o.content.setStyle("background-image","url(data:image/png;base64,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)");break;case"error":o.content.setStyle("background-image","url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABsVJREFUeNqkWFtsFGUU/nZn2r21IqX3llp6AQmkWDVGAgIlGI0EeMAHffAFa998MCQaE8JDxZCgSHzQKIm3qPHFGC7GW0xqkIgIKhhEwFJaKSDQUtplu73s7vidmX/q32F2uw2TnOzMv2fO+f5z/8fci7yvWAZYRXo4CCwLAM1cq+HvXRYwQrrM/7rTwB+TwC/dwKG3uU75mVxCO7T7wExgKHiBATzJ2411wMoy3pSQ5gg6UiFpgpQgDZNukK6TLgBHuf7lAPD5q8DfXMpQl5U3mA4P4ztAO3+2tADLCQSV+VsR/5L+If0G/EqgH78EvKtwT1lqr0en6SfoLaCe1niB7nj+CQIuV+uZWYApV8RNPPAVcP/rQMtF4I03gbNcpjdvt5KxQXs4SKKflxBI54PAs20EElNvZTQJucjLFyUtpZwioJVurFtMD/4MXBXWDUqnL5jHHYt0PgQ8da/4UFMwThpTz0HF7wfEj0/kSKwVAwsZU5U1wKkTwOBBj7GD08xE17QSSJPanVCKlCSNkM5s2mT/JtV6epZ8InclsH4R9TjYRKWPZQixnch2POJsZNpOb5HOb9yIi5s3I5XJIHb2rL2LoBZL+fBZKhOZaS3LgPgh4HcnYZ34scFI+goQxsj8iA+QHipItrejrKwMiaVLMZJIIEpFAaUkH76AFrEVfLxEzzEej/0FXFOGc8CQ8bmFTOE6DciEUnCBCsapoLGxETU1NYhGo7i+YAHiSlFauWMmvqAGKOzcVzDlh2mdo2o/loCJkeEVRnldSMsGUdCrKaiqqkJxcTEikQgKCgpsRbJzk4oukm8iB1+CfEUKkLtZub/CZOsFvht0Qi1lrAfW0WwvN3gyI7J1K+7ZswfNzc0oLS1FKBRCMBiEaZoIh8OOovp6jI6NYXLLFjQ1NdlAxCKGYaCwsBAlJSWoJ08lwQZTKaSPHJmSL9YZZWZx438eZ8yLMwwWtWeYaqvv9oBJ8UWDyovWrUMgEPi/ZPPeBWT/rlhhx0h1dbUNRABPpSrvBVhixw4kd+26rRyMOq3jCl31kzya0vSiKgW91/DOnbZJ53V22iAsy5pSIopra2vtNflP3KIDcTcwuH074pQT8JEvelkMF4kjpBuY0n1Dbjj7XDcpSCCU+gCKxWK+77hABghkOAsQuUIOivmq3xrSm2qMLJZxrwEKlGJQ5QGUC8gVBSSYQ67hoCidAiPzSCCHZSxVlXopeHhiAk30v8RBtivFQO3etg1Du3fbbihQKe0L3MmqmGrYwaAMRuPKMl6aVCkeJ11jRvSuWYO+vj4kk0lf4bIu/wuf8MfV+5NZ5I87RhhVuAKmTGhsbHPCWSwiwoYoOMQ60tDQgPLycjvNfWOA6/J/Op3GefJzsMLcAwfs6PSz0JhTXAfcBDNlVCS0xaYHSEql3jCBRLSC5k3faV1XZZnwySWABmUqJKCo8oUOaNTZbL9SlzE4Niwh8lURLf/TyoQzAZFgdcmvDklhjKsKXKAqsF5rZEztAboOAz+KA4xHmeo0+tNFqky7VMkKfJ+nAnuV2rtn1pS0td32n16B67kpRjZuqQrs6pB5mW37s5OswoLNaOTUdRfQRjPWGhrqOF80aYVSTwXWgfQQSL8URiqa6wGkV+B+ZuAlTwUWF/VxyPoUeD/uTH5x4xhjiNapoHXWhj3l+ubhw0hTkbtz3SXdBNJHIJgFn+Vx0Tlg37eOi+RAkTTk+MDueY1WWc64qQ5oZpSXhpSiedrOz1HBBVWZZ8Pn0phzcjj9DfBBvz1r4aYkrz3PvEhZq9lIyfgY3RXwzrY3lKKytWtxhgp6fHaaL5+AoU8stulPvgB+UFZJuPOMPaF/D5wgoGq6q9XMosianER3FiD58iWcDNr/GvCegwtDbjeywShAGQ5Y3aYzZC00PELsDkxFmOGokosv6cy/XV8DHyr3XFfL1rSBnL/WNqKUcw3rQWWhD6A7oaSTPV1dwEecX07CmX1v6W3Re4iz5IAl5xqCiTIMW0zJ5DsAkXKOLxbHy/1iEQ3IiHdYmAbGdZccsBhDXXKcoMAyWqjCynJwywVCqjgbz2kJVokR5RoXyKRkctYTpQ5Iepica+Q4QesMU0GUoCozPjGS0QZ5t9uzJ51ioO6T9FVZc1XFiLgm5X6ROJjvJ5EOZ4iXwaeIs2Elz1WreExtlVFRJjQZjGQekTFAuq80PRazbp6JTtOyxy87FX9EkYCY8H6v6fDMNzNdagayQYXVZ5mIei7UmrHrnQlFSZXJY9qnECuXIjMPMJZ2lHIPj6aaGg0FNOD5CJHWjtl5f0n5T4ABAFHaXG6UVjGNAAAAAElFTkSuQmCC)");break;case"info":o.content.setStyle("background-image","url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABvBJREFUeNqsWF1sFFUUPndm9n+3W5aWLi2VGgJtgy3UEn6MQGI0GgmC0UgfTEjEBxPDA29qYqLGGOODifGBGGOUYOKDPIg2QgykWgUtP1WgLT+lFKFCf9l2uz+z83c9Z3p3u1u6u4Pxpqczd+7MPd8999xzvrPskb2fgsMW4NzaBpxvBsbWMWCrgUEdAKsA4HHO+R2wrOucmxe5qZ9Jjt3ovtX1eRznt0pN2ndof+5eKYcAJ34YJPlFvH3OFV7+uOyPgOQLg+wJAXP5gMkueifM9XTYzMw2W+mZnWbqHjDF09Pc8WFneur2kaHOjwbxewuB8VK6WCnLoCVexcsrnmWNW1zhKMiBKqdWBDM5CfrMKKh3+8+bWurw1W/f/gwfawstVdYyuNIGtMYBxqT9/lVbmRyIZMFlUeKfCdyiPi0WN02ScPdkvGX2KxJa0IOiVETbU0O/Ptr00getamzkY1R+lbAuZiV52fpnC4FY5lqQpPe80bX7/A2bmIRbQcpzggAQLFhaGiw1aV+5nqEPEQcjWDnAJJLLC57q1Ux2+9tATzwUXN40PH3j7Nj4hWMW6cbr4mDmLIJAals63Esbsk8LhFsGAkjBY3UaPN8M8HKbBGsiHBRmwK1pEy0kC+Pkf4eK/EtA8gTX8Mxs1Lukti9+6+IUAco3ROE24dZ4apo6XEvq57dkQbPQKtsQ575NleB1z30erQbYsMoApScJ3bd1kMRWLWw0r9/Ud+Ci72H3AMoMinGfZchZ0Ufe961Yz/LNvFBoi/ZuDMKaukoIBAIQDofB7XaD1+MGl8Thl6EMWkYq+r3srQAzfrc1VN8yG7t26k/UpGfNJ+WOL54ab30746TQMkuIBVuaaiAUCoHf7wdFUewr9ek5jZf8HucnPe7Q0j3R9t0tqNdtn4AsGIoj7sjKLbI3ZDtiKSEnvTyqgSzLhScB+/ScxsvNQXq8NY0twdrGF/DTYBYH/QtQQJN9lbZzlhOa7MRADHRDnB4h1KfnNO5kHtLnCkSeCERXR4V1QK5e98yTij/ypquyrug+Fwhu7+BoGsbjGngVCaoq3NA7PAuHT4/BjxdjUMrf8oUpqN/IRNGO/TM3e69QQFQo1zB3wN7PMokht+802Q/nUij/5MVyNnesJTnrAmUb6UXfacPb71ESCiU9CkxQBsxcfFHB0tXFjz2CkRQP5iw/AlIcgSG9sjfYiLc+CjMKZV8mk4GM0mBw/MDTUdjc4ANVVUHXdftk5AIWnqozf6tw8FQc44yz/EV6ZZe3XvgM9ogGUFwoYxmav7IyAitXLgNN0yCRSNiAcgHN5YJdyyU42N2LSzYdopHId6rmwdh8BBz4DMA7Ry7D71fG4d2OFjvQFVqOg2EY837lsGGADIhMIFGojIOpoWUMB2LCsd4RSGdKbKmjeYSgXgSeEoZnCjE0y8iEMa06Wgk3DQxOJiZvdFhJWsTRnVuGIxjL0CazGVWxqaKeaba5iLMZcoGu2Dg4BYPUA0/niEiWlkKc1TLUnXYQcjKBZZQd55azhaFeMNLx6xTwiHApRJ65oTleTdn3rAewDOpVY3cGcmCIxQfrPD3I6DYRuS5vGbPsuBOfISqiJyb7Jge6zmE3TVslUTmBCDs5miy3qqJCJ6CMItPMnbxSQvoyM2OnM9N3iWglbcsQW6dyAq2yW5Hk9rncUiQ3oSKT9hnjCTkwRd15DKb93DRwkQwToVw8R5Hl0CoDscE/TmI3jqLSBttnk+oaKiesTJIT4V5MuGHY5Ht7cxWk00jGrcL8RH16TuM2STcMKDYX6UlN3Dw+PdQzKMBoOdpJDH1qoOuvSOPWWklxt9krWkg3cTVv7NkAr+3aaFNNsko+n6G+z+eDra0PQU2lD37rv7MonSBfUaduHx0+/skXODqGEsvyYNsyoobRqK4xUrFOCkZ2vMgThqYPBUMQDAbtYJcPJCv0nMbpPXp/4Rw0L/pI12T/yW9Q36QAomU5cEFFiQWW0vDU6xu9kRVvuXwVO+wE+n81pB2Z+HjX1JXuQ1NzJ2i0aHVADbeLU4FFdY3s9vkll6eVAWcLa6cHFeQ/XL03cnTi0k9fYUVwgVQJXzGKVpTCfywqsBB9F5UTyDmq8aTVsP8Cgk5ZJjGQHL32NfkIBrjhPCA6uUfRijIfEO0l1TWKJ3gWnXoG61w/U1zRnFPC/VVjlvFRM9REH4aM7yYunfhy7PzRn4WzThC9pOFsrZ0PpuSvEOhDkiA+QWLxS5u2byPOSlSRGBoRI+IjRAMo+1LSo1xDIZ4iqwhocSGJcr9COCGITJw6AuUVpY1P9N2CGDFhHkOcDk2E+KQIaNS3Ck24uKIHaQRKFgBkIVIeGFJoCjHE1XI6+b8CDABnZtjY0mkIGQAAAABJRU5ErkJggg==)");break;case"warn":o.content.setStyle("background-image","url(data:image/png;base64,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)");break;default:}o.show()}.bind(this))},notice:function(t,e,i,s){if(!s)s={x:"right",y:"top"};if(!i)i=this.node;if(!e)e="ok";var o=i||layout.layout.contentNode;new mBox.Notice({type:e,position:s,move:false,target:o,delayClose:e==="error"?5e3:1e3,offset:{x:10,y:s.y.toString().toLowerCase()==="bottom"?10:10},content:t})},resetWork:function(){if(!this.businessData.control["allowReset"]){MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied");return false}MWF.require("MWF.xDesktop.Dialog",function(){var t=680;var e=300;var i=MWF.getCenterPosition(this.app.content,t,e);var s=this;var o=new MWF.xDesktop.Dialog({title:this.app.lp.reset,style:"work",top:i.y-100,left:i.x,fromTop:i.y-100,fromLeft:i.x,width:t,height:e,url:this.app.path+"reset.html",container:this.app.content,isClose:true,onPostShow:function(){$("resetWork_okButton").addEvent("click",function(){s.doResetWork(this)}.bind(this));$("resetWork_cancelButton").addEvent("click",function(){this.close()}.bind(this));$("resetWork_selPeopleButton").addEvent("click",function(){s.selectPeople(this)}.bind(this))}});o.show()}.bind(this))},selectPeople:function(e){var t=this.businessData.activity.resetRange||"department";var i=this.businessData.activity.resetCount||0;switch(t){case"unit":this.selectPeopleUnit(e,this.businessData.task.unit,i);break;case"topUnit":MWF.require("MWF.xScript.Actions.UnitActions",function(){orgActions=new MWF.xScript.Actions.UnitActions;var t={unitList:[this.businessData.task.unit]};orgActions.listUnitSupNested(t,function(t){v=t.data[0];this.selectPeopleUnit(e,v,i)}.bind(this))}.bind(this));break;default:this.selectPeopleAll(e,i)}},selectPeopleUnit:function(i,t,e){var s=i.identityList||[];var o=$("resetWork_selPeopleArea");var n={values:s,type:"identity",count:e,units:t?[t]:[],title:this.app.lp.reset,onComplete:function(t){o.empty();var e=[];t.each(function(t){new MWF.widget.O2Identity(t.data,o,{style:"reset"});e.push(t.data.distinguishedName)}.bind(this));i.identityList=e}.bind(this)};var a=new MWF.O2Selector(this.app.content,n)},selectPeopleAll:function(i,t){var e=i.identityList||[];var s=$("resetWork_selPeopleArea");var o={values:e,type:"identity",count:t,title:this.app.lp.reset,onComplete:function(t){s.empty();var e=[];t.each(function(t){new MWF.widget.O2Identity(t.data,s,{style:"reset"});e.push(t.data.distinguishedName)}.bind(this));i.identityList=e}.bind(this)};var n=new MWF.O2Selector(this.app.content,o)},doResetWork:function(o){var e=o.identityList||[];if(!e.length){this.app.notice(MWF.xApplication.process.Xform.LP.inputResetPeople,"error",o.node);return false}var t=$("resetWork_opinion").get("value");var i=[];e.each(function(t){i.push(MWF.name.cn(t))});if(!t){t=MWF.xApplication.process.Xform.LP.resetTo+": "+i.join(", ")}MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4});this.mask.loadNode(this.app.content);this.fireEvent("beforeReset");if(this.app&&this.app.fireEvent)this.app.fireEvent("beforeReset");this.resetWorkToPeson(e,t,function(){this.workAction.getJobByWork(function(t){this.fireEvent("afterReset");if(this.app&&this.app.fireEvent)this.app.fireEvent("afterReset");this.addResetMessage(t.data);this.app.notice(MWF.xApplication.process.Xform.LP.resetOk+": "+MWF.name.cns(e).join(", "),"success");this.app.close()}.bind(this),null,this.businessData.work.id);o.close();if(this.mask){this.mask.hide();this.mask=null}}.bind(this),function(t,e,i){var s=i+":"+e;if(t)s=t.responseText;this.app.notice("request json error: "+s,"error",o.node);if(this.mask){this.mask.hide();this.mask=null}}.bind(this))}.bind(this))},resetWorkToPeson:function(t,e,i,s){var o={opinion:e,routeName:MWF.xApplication.process.Xform.LP.reset,identityList:t};this.saveFormData(function(t){this.workAction.resetWork(function(t){if(i)i()}.bind(this),function(t,e,i){if(s)s(t,e,i)},this.businessData.task.id,o)}.bind(this),function(t,e,i){if(s)s(t,e,i)},true,null,true)},addResetMessage:function(t){var e=[];t.taskList.each(function(t){e.push(MWF.name.cn(t.person)+"("+MWF.name.cn(t.unit)+")")}.bind(this));var i="<div><b>"+MWF.xApplication.process.Xform.LP.currentActivity+'<font style="color: #ea621f">'+t.work.activityName+"</font>, "+MWF.xApplication.process.Xform.LP.nextUser+'<font style="color: #ea621f">'+e.join(", ")+"</font></b></div>";var s={subject:MWF.xApplication.process.Xform.LP.workReset,content:"<div>"+MWF.xApplication.process.Xform.LP.resetWorkInfor+"“"+this.businessData.work.title+"”</div>"+i};layout.desktop.message.addTooltip(s);return layout.desktop.message.addMessage(s)},retractWork:function(t,e){var o=this;var i=MWF.getCenterPosition(this.app.content,300,150);var s={event:{x:i.x,y:i.y-200,clientX:i.x,clientY:i.y-200}};this.app.confirm("infor",s,MWF.xApplication.process.Xform.LP.retractTitle,MWF.xApplication.process.Xform.LP.retractText,300,120,function(){o.app.content.mask({style:{"background-color":"#999",opacity:.6}});MWF.require("MWF.widget.Mask",function(){o.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4});o.mask.loadNode(o.app.content);o.fireEvent("beforeRetract");if(o.app&&o.app.fireEvent)o.app.fireEvent("beforeRetract");o.doRetractWork(function(){o.workAction.getJobByWork(function(t){o.fireEvent("afterRetract");if(o.app&&o.app.fireEvent)o.app.fireEvent("afterRetract");o.app.notice(MWF.xApplication.process.Xform.LP.workRetract,"success");o.app.content.unmask();o.app.reload(t.data)},null,o.businessData.work.id);this.close();if(o.mask){o.mask.hide();o.mask=null}}.bind(this))}.bind(this),function(t,e,i){var s=i+":"+e;if(t)s=t.responseText;o.app.notice("request json error: "+s,"error",dlg.node);if(o.mask){o.mask.hide();o.mask=null}})},function(){this.close()})},doRetractWork:function(e,s){if(this.businessData.control["allowRetract"]){this.workAction.retractWork(function(t){if(e)e()}.bind(this),function(t,e,i){if(s)s(t,e,i)},this.businessData.work.id)}else{if(s)s(null,"Permission Denied","")}},addRetractMessage:function(t){var e=[];t.taskList.each(function(t){e.push(MWF.name.cn(t.person)+"("+MWF.name.cn(t.unit)+")")}.bind(this));var i="<div><b>"+MWF.xApplication.process.Xform.LP.currentActivity+'<font style="color: #ea621f">'+t.work.activityName+"</font>, "+MWF.xApplication.process.Xform.LP.nextUser+'<font style="color: #ea621f">'+e.join(", ")+"</font></b></div>";var s={subject:MWF.xApplication.process.Xform.LP.workRetract,content:"<div>"+MWF.xApplication.process.Xform.LP.retractWorkInfor+"“"+this.businessData.work.title+"”</div>"+i};layout.desktop.message.addTooltip(s);return layout.desktop.message.addMessage(s)},rerouteWork:function(t,e){if(!this.businessData.control["allowReroute"]){MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied");return false}MWF.require("MWF.xDesktop.Dialog",function(){var t=480;var e=160;var i=MWF.getCenterPosition(this.app.content,t,e);var s=this;var o=new MWF.xDesktop.Dialog({title:this.app.lp.reroute,style:"work",top:i.y-100,left:i.x,fromTop:i.y-100,fromLeft:i.x,width:t,height:e,url:this.app.path+"reroute.html",container:this.app.content,isClose:true,onPostShow:function(){$("rerouteWork_okButton").addEvent("click",function(){s.doRerouteWork(this)}.bind(this));$("rerouteWork_cancelButton").addEvent("click",function(){this.close()}.bind(this));var e=$("rerouteWork_selectActivity");s.workAction.getRerouteTo(s.businessData.work.process,function(t){t.data.agentList.each(function(t){new Element("option",{value:t.id+"#agent",text:t.name}).inject(e)}.bind(s));t.data.cancelList.each(function(t){new Element("option",{value:t.id+"#cancel",text:t.name}).inject(e)}.bind(s));t.data.choiceList.each(function(t){new Element("option",{value:t.id+"#choice",text:t.name}).inject(e)}.bind(s));t.data.controllerList.each(function(t){new Element("option",{value:t.id+"#condition",text:t.name}).inject(e)}.bind(s));t.data.delayList.each(function(t){new Element("option",{value:t.id+"#delay",text:t.name}).inject(e)}.bind(s));t.data.embedList.each(function(t){new Element("option",{value:t.id+"#embed",text:t.name}).inject(e)}.bind(s));t.data.endList.each(function(t){new Element("option",{value:t.id+"#end",text:t.name}).inject(e)}.bind(s));t.data.invokeList.each(function(t){new Element("option",{value:t.id+"#invoke",text:t.name}).inject(e)}.bind(s));t.data.manualList.each(function(t){new Element("option",{value:t.id+"#manual",text:t.name}).inject(e)}.bind(s));t.data.mergeList.each(function(t){new Element("option",{value:t.id+"#merge",text:t.name}).inject(e)}.bind(s));t.data.messageList.each(function(t){new Element("option",{value:t.id+"#message",text:t.name}).inject(e)}.bind(s));t.data.parallelList.each(function(t){new Element("option",{value:t.id+"#parallel",text:t.name}).inject(e)}.bind(s));t.data.serviceList.each(function(t){new Element("option",{value:t.id+"#service",text:t.name}).inject(e)}.bind(s));t.data.splitList.each(function(t){new Element("option",{value:t.id+"#split",text:t.name}).inject(e)}.bind(s))}.bind(s))}});o.show()}.bind(this))},doRerouteWork:function(o){var t=$("rerouteWork_opinion").get("value");var e=$("rerouteWork_selectActivity");var i=e.options[e.selectedIndex].get("value");var s=e.options[e.selectedIndex].get("text");var n=i.split("#");i=n[0];var a=n[1];MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4});this.mask.loadNode(this.app.content);this.fireEvent("beforeReroute");if(this.app&&this.app.fireEvent)this.app.fireEvent("afterRetract");this.rerouteWorkToActivity(i,a,t,function(){this.workAction.getJobByWork(function(t){this.fireEvent("afterReroute");if(this.app&&this.app.fireEvent)this.app.fireEvent("afterReroute");this.addRerouteMessage(t.data);this.app.notice(MWF.xApplication.process.Xform.LP.rerouteOk+": "+s,"success");this.app.close()}.bind(this),null,this.businessData.work.id);o.close();if(this.mask){this.mask.hide();this.mask=null}}.bind(this),function(t,e,i){var s=i+":"+e;if(t)s=t.responseText;this.app.notice("request json error: "+s,"error",o.node);if(this.mask){this.mask.hide();this.mask=null}}.bind(this))}.bind(this))},rerouteWorkToActivity:function(e,i,t,s,o){if(this.businessData.task){this.saveFormData(function(t){this.workAction.rerouteWork(function(t){if(s)s()}.bind(this),function(t,e,i){if(o)o(t,e,i)},this.businessData.work.id,e,i)}.bind(this),function(t,e,i){if(o)o(t,e,i)},true,null,true)}else{this.workAction.rerouteWork(function(t){if(s)s()}.bind(this),function(t,e,i){if(o)o(t,e,i)},this.businessData.work.id,e,i)}},addRerouteMessage:function(t){var e=[];t.taskList.each(function(t){e.push(MWF.name.cn(t.person)+"("+MWF.name.cn(t.unit)+")")}.bind(this));var i="<div><b>"+MWF.xApplication.process.Xform.LP.currentActivity+'<font style="color: #ea621f">'+t.work.activityName+"</font>, "+MWF.xApplication.process.Xform.LP.nextUser+'<font style="color: #ea621f">'+e.join(", ")+"</font></b></div>";var s={subject:MWF.xApplication.process.Xform.LP.workReroute,content:"<div>"+MWF.xApplication.process.Xform.LP.rerouteWorkInfor+"“"+this.businessData.work.title+"”</div>"+i};layout.desktop.message.addTooltip(s);return layout.desktop.message.addMessage(s)},deleteWork:function(){var o=this;var t=MWF.getCenterPosition(this.app.content,380,150);var e={event:{x:t.x,y:t.y-200,clientX:t.x,clientY:t.y-200}};this.app.confirm("infor",e,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText,380,120,function(){MWF.require("MWF.widget.Mask",function(){o.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4});o.mask.loadNode(o.app.content);debugger;o.fireEvent("beforeDelete");if(o.app&&o.app.fireEvent)o.app.fireEvent("beforeDelete");o.doDeleteWork(function(){o.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+o.businessData.work.title+"”","success");o.app.close();this.close();if(o.mask){o.mask.hide();o.mask=null}}.bind(this),function(t,e,i){var s=i+":"+e;if(t)s=t.responseText;o.app.notice("request json error: "+s,"error",dlg.node);if(o.mask){o.mask.hide();o.mask=null}}.bind(this))}.bind(this))},function(){this.close()},null,this.app.content)},doDeleteWork:function(e,s){if(this.businessData.control["allowDelete"]){this.workAction.deleteWork(function(t){if(e)e()}.bind(this),function(t,e,i){if(s)s(t,e,i)},this.businessData.work.id)}else{if(s)s(null,"Permission Denied","")}},printWork:function(t,e){var i=t||this.businessData.work?this.businessData.work.application:this.businessData.workCompleted.application;var e=e;debugger;if(!e){e=this.json.id;if(this.json.printForm)e=this.json.printForm}if(this.businessData.workCompleted){var i=t||this.businessData.workCompleted.application;window.open("/x_desktop/printWork.html?workCompletedId="+this.businessData.workCompleted.id+"&app="+i+"&form="+e)}else{var i=t||this.businessData.work.application;window.open("/x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+i+"&form="+e)}},readedWork:function(t){var i=this;var e="您确定要将“"+this.businessData.work.title+"”标记为已阅吗？";this.app.confirm("infor",t,"标记已阅确认",e,350,150,function(){var t=null;for(var e=0;e<i.businessData.readList.length;e++){if(i.businessData.readList[e].person===layout.session.user.distinguishedName){t=i.businessData.readList[e];break}}if(t){i.app.action.setReaded(function(){i.app.reload()}.bind(i),null,t.id,t)}else{i.app.reload()}this.close()},function(){this.close()},null,this.app.content)},openWindow:function(t,e){var t=t;if(!t){t=this.json.id}if(this.businessData.workCompleted){var i=e||this.businessData.workCompleted.application;window.open("/x_desktop/printWork.html?workCompletedId="+this.businessData.workCompleted.id+"&app="+i+"&form="+t)}else{var i=e||this.businessData.work.application;window.open("/x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+i+"&form="+t)}},uploadedAttachment:function(i,t){this.workAction.getAttachment(t,this.businessData.work.id,function(t){var e=this.all[i];if(e){if(t.data)e.attachmentController.addAttachment(t.data);e.attachmentController.checkActions();e.fireEvent("upload",[t.data])}}.bind(this))},replacedAttachment:function(n,a){this.workAction.getAttachment(a,this.businessData.work.id,function(t){var e=this.all[n];if(e){var i=e.attachmentController;var s=null;for(var o=0;o<i.attachments.length;o++){if(i.attachments[o].data.id===a){s=i.attachments[o];break}}s.data=t.data;s.reload();i.checkActions()}}.bind(this))}});