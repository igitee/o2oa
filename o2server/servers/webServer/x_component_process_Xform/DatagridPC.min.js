MWF.xDesktop.requireApp("process.Xform","$Module",null,false);MWF.xApplication.process.Xform.DatagridPC=new Class({Implements:[Events],Extends:MWF.APP$Module,isEdit:false,options:{moduleEvents:["completeLineEdit","addLine","deleteLine","afterDeleteLine"]},initialize:function(t,e,i,s){this.node=$(t);this.node.store("module",this);this.json=e;this.form=i;this.field=true},_loadUserInterface:function(){this.editModules=[];this.node.setStyle("overflow-x","auto");this.node.setStyle("overflow-y","hidden");this.table=this.node.getElement("table");this.editable=this.readonly?false:true;if(this.editable)this.editable=this.form.Macro.exec(this.json.editableScript.code,this);this.gridData=this._getValue();this.totalModules=[];this._loadDatagridTitleModules();if(this.editable!=false){this._loadDatagridDataModules();this._addTitleActionColumn();debugger;this._loadEditDatagrid()}else{this._loadReadDatagrid()}},_loadStyles:function(){this.table.setStyles(this.json.tableStyles);this.node.setStyles(this.json.styles)},_getValue:function(){var t=[];t=this._getBusinessData();if(!t){if(this.json.defaultData.code)t=this.form.Macro.exec(this.json.defaultData.code,this);t={data:t||[]}}return t||{}},_getDatagridTr:function(){this._getDatagridTitleTr();this._getDatagridEditorTr()},_getDatagridTitleTr:function(){this.titleTr=this.table.getElement("tr");return this.titleTr},_getDatagridEditorTr:function(){var t=this.table.getElements("tr");this.editorTr=t[t.length-1];this.editorTr.addClass("datagridEditorTr");return this.editorTr},_addTitleActionColumn:function(){if(!this.titleTr)this._getDatagridTitleTr();if(!this.editorTr)this._getDatagridEditorTr();var t=new Element("th",{styles:{width:"46px"}}).inject(this.titleTr,"top");new Element("th").inject(this.titleTr,"bottom");this._createAddLineAction(t);var e=new Element("td").inject(this.editorTr,"top");this._createCompleteAction(e);new Element("td").inject(this.editorTr,"bottom")},_loadEditDatagrid:function(){var o=this.titleTr.getElements("th");var l=this.editorTr.getElements("td");debugger;if(this.gridData.data){this.gridData.data.each(function(r,t){var n=$(this.table.insertRow(t+1));n.store("data",r);o.each(function(t,e){var i=r[t.get("id")];var s="";for(key in i){var a=i[key];s=this._getValueText(e-1,a);break}this._createNewEditTd(n,e,l[e].get("id"),s,o.length-1)}.bind(this))}.bind(this))}this.editorTr.setStyle("display","none")},_getValueText:function(t,e){var i=this.editModules[t];if(i){switch(i.json.type){case"Select":var s=i.node.getElements("option");for(var a=0;a<s.length;a++){if(s[a].value==e){return s[a].get("text");break}}break;case"Radio":var s=i.node.getElements("input");for(var a=0;a<s.length;a++){if(s[a].value==e){return s[a].get("showText");break}}break;case"Checkbox":var s=i.node.getElements("input");var r=[];for(var a=0;a<s.length;a++){if(e.indexOf(s[a].value)!=-1)r.push(s[a].get("showText"))}if(r.length)return r.join(", ");break;case"Orgfield":case"Personfield":if(typeOf(e)==="array"){var n=[];e.each(function(t){if(typeOf(t)==="object"){n.push(t.name+(t.unitName?"("+t.unitName+")":""))}else{n.push(t)}}.bind(this));return n.join(", ")}else if(typeOf(e)==="object"){return e.name+(e.unitName?"("+e.unitName+")":"")}else{return e}break}}return e},_createNewEditTd:function(t,e,i,s,a){var r=$(t.insertCell(e));if(e==0){r.setStyles(this.form.css.gridLineActionCell);this._createAddLineAction(r);this._createDelLineAction(r)}else if(e==a){r.setStyles(this.form.css.gridMoveActionCell);this._createMoveLineAction(r)}else{r.set("MWFId",i);r.set("text",s);r.addEvent("click",function(t){this._editLine(t.target)}.bind(this))}var n=this.form._getDomjson(r);if(n){r.store("dataGrid",this);var o=this.form._loadModule(n,r);r.store("module",o);this.form.modules.push(o)}},_createAddLineAction:function(t){var e=new Element("div",{styles:this.form.css.addLineAction,events:{click:function(t){this._addLine(t.target)}.bind(this)}});e.inject(t)},_createDelLineAction:function(t){var e=new Element("div",{styles:this.form.css.delLineAction,events:{click:function(t){this._deleteLine(t)}.bind(this)}});e.inject(t)},_createCompleteAction:function(t){var e=new Element("div",{styles:this.form.css.completeLineAction,events:{click:function(t){this._completeLineEdit(t)}.bind(this)}});e.inject(t)},_editLine:function(t){if(this.isEdit){if(!this._completeLineEdit())return false}this.currentEditLine=t.getParent("tr");if(this.currentEditLine){this.editorTr.setStyles({display:"table-row"});this.editorTr.inject(this.currentEditLine,"before");this.currentEditLine.setStyle("display","none");var a=this.currentEditLine.retrieve("data");var e=this.titleTr.getElements("th");e.each(function(t,e){var i=t.get("id");var s=this.editModules[e-1];if(s){if(s.json.type=="sequence"){s.node.set("text",s.node.getParent("tr").rowIndex)}else{if(a[i]){s.setData(a[i][s.json.id])}else{s.setData(null)}}}}.bind(this));var i=this.currentEditLine.getElements("td").indexOf(t);var s=this.editModules[i-1];if(s)s.focus();this.isEdit=true}this.validationMode()},editValidation:function(){var i=true;this.editModules.each(function(t,e){if(t.json.type!="sequence"){t.validationMode();if(!t.validation())i=false}}.bind(this));return i},_completeLineEdit:function(){if(!this.editValidation()){return false}this.isEdit=false;var o=true;var l={};var d=null;if(this.currentEditLine){d=this.currentEditLine;l=this.currentEditLine.retrieve("data")}else{d=new Element("tr").inject(this.editorTr,"before");l={}}var h=this.titleTr.getElements("th");var f=this.editorTr.getElements("td");var c=d.getElements("td");h.each(function(t,e){var i=c[e];var s=t.get("id");var a=this.editModules[e-1];if(a){if(a.json.type=="sequence"){var r=d.rowIndex;var n={value:[r],text:[r]}}else{var n=a.getTextData();if(n.value[0])o=false;if(n.value.length<2){if(!l[s])l[s]={};l[s][a.json.id]=n.value[0]}else{if(!l[s])l[s]={};l[s][a.json.id]=n.value}}if(i){i.set("text",n.text.join(", "))}else{this._createNewEditTd(d,e,f[e].get("id"),n.text.join(", "),h.length-1)}}else{if(!i)this._createNewEditTd(d,e,s,"",h.length-1)}a=null}.bind(this));d.store("data",l);d.setStyle("display","table-row");if(o){d.destroy()}this.currentEditLine=null;this._editorTrGoBack();if(this.json.contentStyles){var t=d.getElements("td");t.setStyles(this.json.contentStyles)}if(this.json.actionStyles){d.getFirst().setStyles(this.json.actionStyles)}this._loadBorderStyle();this._loadZebraStyle();this._loadSequence();this.getData();this.validationMode();this.fireEvent("completeLineEdit");return true},_editorTrGoBack:function(){this.editorTr.setStyle("display","none");if(this.totalTr){this.editorTr.inject(this.totalTr,"before")}else{var t=this.table.getElements("tr");var e=t[t.length-1];this.editorTr.inject(e,"after")}},_addLine:function(t){if(this.isEdit){if(!this._completeLineEdit())return false}this.editorTr.setStyles({display:"table-row"});this.currentEditLine=null;var e=t.getParent("tr");if(e){this.editorTr.inject(e,"after")}this.isEdit=true;this.validationMode();this.fireEvent("addLine")},_deleteLine:function(t){var e=t.target.getParent("tr");if(e){var i=e.getStyle("background");e.store("bgcolor",i);e.tween("background-color","#ffd4d4");var s=this;var a=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteDatagridLine,300,120,function(){a.fireEvent("deleteLine",[e]);e.destroy();s._loadZebraStyle();s._loadSequence();s._loadTotal();s.getData();this.close();a.fireEvent("afterDeleteLine")},function(){var t=e.retrieve("bgcolor");e.tween("background",t);this.close()},null)}this.validationMode()},_createMoveLineAction:function(t){var e=new Element("div",{styles:this.form.css.moveLineAction,events:{mousedown:function(t){this._moveLine(t)}.bind(this)}});e.inject(t)},_getMoveDragNode:function(t){var e=t.getParent("table");var i=e.getParent("div");var s=i.getSize();var a=i.clone().setStyle("width",s.x).inject(document.body);var r=a.getElement("table");r.empty();var n=t.clone().setStyles(this.form.css.gridMoveLineDragNodeTr).inject(r);var o=t.getElements("td");var l=n.getElements("td");o.each(function(t,e){var i=t.getComputedSize();l[e].setStyle("width",i.width+1)});var d=t.getCoordinates();a.setStyles(this.form.css.gridMoveLineDragNode);a.setStyles(d);return a},_moveLine:function(t){var e=this.table.getElements("tr");var i=t.target;var s=i.getParent("tr");var a=this._getMoveDragNode(s);coordinates=a.getCoordinates();var r=a.getElement("tr");var n=a.getElement("table");var o=s.getStyle("background");s.store("bgcolor",o);s.tween("background-color","#e4f6e9");var l=new Drag.Move(a,{droppables:e.erase(s),limit:{x:[coordinates.left,coordinates.left]},onDrop:function(t,e){t.destroy();var i=s.retrieve("bgcolor");if(i){s.tween("background",i)}else{s.tween("background","transparent")}s.setStyle("display","table-row");if(e!=null){s.inject(r,"after");r.destroy();this._loadDatagridStyle();this.getData()}}.bind(this),onEnter:function(t,e){a.setStyle("display","none");r.inject(e,"after")},onLeave:function(t,e){r.inject(n);a.setStyle("display","block")},ondrag:function(){this.table.setStyle("cursor","move");a.setStyle("cursor","move")},onCancel:function(t){t.destroy();var e=s.retrieve("bgcolor");if(e){s.tween("background",e)}else{s.tween("background","transparent")}s.setStyle("display","table-row")}});l.start(t);s.setStyle("display","none")},_loadReadDatagrid:function(){debugger;this.gridData=this._getValue();if(!this.titleTr)this._getDatagridTitleTr();var e=this.titleTr.getElements("th");var t=this.table.getElements("tr");var i=t[t.length-1];var l=i.getElements("td");if(this.gridData.data){this.gridData.data.each(function(n,t){var o=this.table.insertRow(t+1);o.store("data",n);e.each(function(t,e){var i=o.insertCell(e);i.set("MWFId",l[e].get("id"));var s=n[t.get("id")];if(s){for(key in s){var a=s[key];if(typeOf(a)==="array"){var r=[];a.each(function(t){if(typeOf(t)==="object"){r.push(t.name+(t.unitName?"("+t.unitName+")":""))}else{r.push(t)}}.bind(this));i.set("text",r.join(", "))}else if(typeOf(a)==="object"){i.set("text",a.name+(a.unitName?"("+a.unitName+")":""))}else{i.set("text",a)}break}}else{i.setStyle("text-align","center");i.set("text",o.rowIndex)}}.bind(this))}.bind(this))}i.destroy();this._loadTotal()},_loadDatagridStyle:function(){this.loadGridTitleStyle();this.loadGridContentStyle();this.loadGridActionStyle();this.loadGridEditStyle();this._loadTotal();this._loadBorderStyle();this._loadZebraStyle();this._loadSequence()},loadGridEditStyle:function(){if(this.editorTr){if(this.json.editStyles){var t=this.editorTr.getElements("td");t.setStyles(this.json.editStyles)}}},loadGridActionStyle:function(){if(this.editable!=false){if(this.json.actionStyles){var t=this.table.getElements("tr");t.each(function(t,e){if(e!=0)t.getFirst().setStyles(this.json.actionStyles)}.bind(this))}}},loadGridTitleStyle:function(){if(this.json.titleStyles){var t=this.titleTr.getElements("th");t.setStyles(this.json.titleStyles)}},loadGridContentStyle:function(){if(this.json.contentStyles){var t=this.table.getElements("td");t.setStyles(this.json.contentStyles)}},_loadZebraStyle:function(){var t=this.table.getElements("tr");for(var e=1;e<t.length;e++){if(!t[e].hasClass("datagridTotalTr")){if(this.json.backgroundColor)t[e].setStyle("background-color",this.json.backgroundColor);if(e%2==0){if(this.json.zebraColor)t[e].setStyle("background-color",this.json.zebraColor)}}}},createTotalTr:function(){var t=this.node.getElements("tr");var e=t[t.length-1];this.totalTr=new Element("tr.datagridTotalTr",{styles:this.form.css.datagridTotalTr}).inject(e,"after");var i=this.node.getElements("th");i.each(function(t,e){var i=new Element("td",{text:"",styles:this.form.css.datagridTotalTd}).inject(this.totalTr);if(this.json.amountStyles)i.setStyles(this.json.amountStyles)}.bind(this))},_loadTotal:function(){var r={};this.totalResaults={};if(this.totalModules.length){if(!this.totalTr){this.createTotalTr()}var n=[];var t=this.table.getElements("tr");var s=this.totalTr.getElements("td");for(var e=1;e<t.length;e++){if(!t[e].hasClass("datagridTotalTr")&&!t[e].hasClass("datagridEditorTr")){var o=t[e].getElements("td");this.totalModules.each(function(t,e){if(!n[e])n.push(0);var i=new Decimal(n[e]);if(t.type=="number"){var s=o[t.index];var a=s.get("text").toFloat();i=i.plus(a)}if(t.type=="count"){i=i.plus(1)}n[e]=i.toString();r[t.module.json.id]=n[e]}.bind(this))}}this.totalModules.each(function(t,e){this.totalResaults[t.module.json.id]=n[e];var i=s[t.index];i.set("text",n[e]||"")}.bind(this))}return r},_loadSequence:function(){var t=this.table.getElements("tr");for(var i=1;i<t.length;i++){var e=t[i].getElements("td");e.each(function(t){var e=t.retrieve("module");if(e){if(e.json.cellType=="sequence"){t.set("text",i)}}}.bind(this))}},_loadBorderStyle:function(){if(this.json.border){this.table.setStyles({"border-top":this.json.border,"border-left":this.json.border});var t=this.table.getElements("th");t.setStyles({"border-bottom":this.json.border,"border-right":this.json.border});var e=this.table.getElements("td");e.setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"})}},_loadDatagridTitleModules:function(){var t=this.node.getElements("th");t.each(function(t){var e=this.form._getDomjson(t);t.store("dataGrid",this);if(e){var i=this.form._loadModule(e,t);this.form.modules.push(i)}}.bind(this))},_loadDatagridDataModules:function(){var t=this.node.getElements("td");t.each(function(t){var e=this.form._getDomjson(t);t.store("dataGrid",this);if(e){var i=this.form._loadModule(e,t,function(){this.field=false});t.store("module",i);this.form.modules.push(i)}}.bind(this))},_afterLoaded:function(){this._loadDatagridStyle()},resetData:function(){this.setData(this._getValue())},setData:function(t){if(t){this._setBusinessData(t);this.gridData=t}else{this.gridData=this._getValue()}if(this.isEdit)this._completeLineEdit();if(this.gridData){var e=this.table.getElements("tr");for(var i=1;i<e.length-1;i++){var s=e[i];var a=s.getElements("td");for(var r=0;r<a.length;r++){var n=a[r];var o=n.retrieve("module");if(o){this.form.modules.erase(o);delete o}}}while(this.table.rows.length>2){this.table.rows[1].destroy()}if(this.editable!=false){this._loadEditDatagrid()}else{this._loadReadDatagrid()}this._loadDatagridStyle()}},getTotal:function(){this._loadTotal();return this.totalResaults},getData:function(){if(this.editable!=false){if(this.isEdit)this._completeLineEdit();var t=[];var e=this.table.getElements("tr");for(var i=1;i<e.length-1;i++){var s=e[i];var a=s.retrieve("data");if(a)t.push(a)}this.gridData={};this.gridData.data=t;this._loadTotal();this.gridData.total=this.totalResaults;this._setBusinessData(this.gridData);return this.gridData.data.length?this.gridData:null}else{return this._getBusinessData()}},getAmount:function(){return this._loadTotal()},createErrorNode:function(t){var e=new Element("div");var i=new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url("+"/x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e);var s=new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){if(!this.isNotValidationMode){this.isNotValidationMode=true;this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom"));this.node.setStyle("border","1px solid red");this.errNode=this.createErrorNode(t).inject(this.node,"after");this.showNotValidationMode(this.node)}},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if(e.get("MWFtype")=="tab$Content"){if(e.getParent("div").getStyle("display")=="none"){var i=e.getParent("div").getParent("div");var s=i.getPrevious("div");var a=i.getChildren().indexOf(e.getParent("div"));var r=s.getChildren()[a];r.click();e=s.getParent("div")}}this.showNotValidationMode(e)}},validationMode:function(){if(this.isNotValidationMode){this.isNotValidationMode=false;this.node.setStyles(this.node.retrieve("borderStyle"));if(this.errNode){this.errNode.destroy();this.errNode=null}}},validationConfigItem:function(t,e){var i=e.status=="all"?true:t==e.decision;if(i){var s=this.getData();var a=e.valueType=="value"?s:s.length;switch(e.operateor){case"isnull":if(!a){this.notValidationMode(e.prompt);return false}break;case"notnull":if(a){this.notValidationMode(e.prompt);return false}break;case"gt":if(a>e.value){this.notValidationMode(e.prompt);return false}break;case"lt":if(a<e.value){this.notValidationMode(e.prompt);return false}break;case"equal":if(a==e.value){this.notValidationMode(e.prompt);return false}break;case"neq":if(a!=e.value){this.notValidationMode(e.prompt);return false}break;case"contain":if(a.indexOf(e.value)!=-1){this.notValidationMode(e.prompt);return false}break;case"notcontain":if(a.indexOf(e.value)==-1){this.notValidationMode(e.prompt);return false}break}}return true},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length){for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return false}}return true}return true},validation:function(t,e){if(this.isEdit){if(!this.editValidation()){return false}}if(!this.validationConfig(t,e))return false;if(!this.json.validation)return true;if(!this.json.validation.code)return true;var i=this.form.Macro.exec(this.json.validation.code,this);if(!i)i=MWF.xApplication.process.Xform.LP.notValidation;if(i.toString()!="true"){this.notValidationMode(i);return false}return true}});MWF.xApplication.process.Xform.DatagridPC$Title=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");if(this.json.total=="number"||this.json.total=="count"){this.dataGrid.totalModules.push({module:this,index:this.dataGrid.editable!=false?this.node.cellIndex+1:this.node.cellIndex,type:this.json.total})}}});MWF.xApplication.process.Xform.DatagridPC$Data=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");var t=this.node;debugger;if(this.json.cellType=="sequence"){var e=true;for(var i=0;i<this.dataGrid.editModules.length;i++){if(this.dataGrid.editModules[i].json.id==this.json.id){e=false;break}}if(e){this.dataGrid.editModules.push({json:{type:"sequence",id:this.json.id},node:t,focus:function(){}})}}else{var s=this.form._getModuleNodes(this.node);s.each(function(t){var e=this.form._getDomjson(t);var i=this.form._loadModule(e,t,function(){this.field=false});i.dataModule=this;this.dataGrid.editModules.push(i)}.bind(this))}}});